<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Siap Suruh - Siap Antar</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <style>
    :root{
      --brand-green:#2ea44f;
      --brand-orange:#ff7a00;
      --brand-white:#ffffff;
    }
    body{
      background: var(--brand-white);
      color:#222;
      padding-bottom: 72px; /* space for bottom nav */
    }
    .top-banner{
      background: linear-gradient(90deg,var(--brand-green),var(--brand-orange));
      color: #fff;
      padding: 14px 16px;
      display:flex;
      align-items:center;
      gap:12px;
    }
    .top-banner h1{font-size:1.1rem;margin:0;font-weight:700;letter-spacing:0.5px;}
    .category-card{
      border-radius:12px;
      padding:12px;
      display:flex;
      align-items:center;
      gap:12px;
      cursor:pointer;
      box-shadow:0 1px 4px rgba(0,0,0,0.06);
      transition:transform .08s;
      background: #fff;
    }
    .category-card:active{transform:scale(.998);}
    .icon-circle{
      width:48px;height:48px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      font-size:1.3rem;color:#fff;
    }
    .icon-motor{background:var(--brand-green);}
    .icon-box{background:var(--brand-orange);}
    .icon-home{background:#4aa0d4;}
    .icon-garden{background:#7bc86f;}
    .icon-tire{background:#ffb86b;}
    .bottom-nav{
      position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e6e6e6;padding:8px 12px;display:flex;justify-content:space-around;z-index:1050;
    }
    /* map modal sizes */
    #map, #map2 { width:100%; height:60vh; }
    .small-note{font-size:.85rem;color:#555}
    .km-badge{font-weight:600}
    /* for mobile touch targets */
    .btn-large{padding:.6rem .9rem;font-size:1rem;border-radius:10px;}
  </style>
</head>
<body>

  <!-- Top Banner -->
  <div class="top-banner">
    <div style="display:flex;gap:10px;align-items:center;">
      <img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='36' height='36'><rect rx='8' width='36' height='36' fill='%23ffffff'/><text x='50%' y='58%' text-anchor='middle' font-size='14' font-family='Arial' fill='%23000000' font-weight='700'>SS</text></svg>" alt="logo" style="width:40px;height:40px;border-radius:8px;background:#fff;padding:6px;">
    </div>
    <div>
      <h1>SIAP SURUH, SIAP ANTAR</h1>
      <div style="font-size:.85rem;opacity:.95">Layanan antar, kirim paket, bersihin & tempel ban</div>
    </div>
  </div>

  <div class="container my-3">

    <!-- Categories -->
    <div class="row g-3">
      <div class="col-12">
        <div class="category-card" data-bs-toggle="modal" data-bs-target="#modalAntar">
          <div class="icon-circle icon-motor"><i class="bi bi-bicycle"></i></div>
          <div>
            <div style="font-weight:700">Jasa Antar (Antar Jemput)</div>
            <div class="small-note">Antar jemput orang / barang ringan</div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="category-card" data-bs-toggle="modal" data-bs-target="#modalKirim">
          <div class="icon-circle icon-box"><i class="bi bi-box-seam"></i></div>
          <div>
            <div style="font-weight:700">Kirim Paket</div>
            <div class="small-note">Kirim paket / dokumen</div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="category-card" data-bs-toggle="modal" data-bs-target="#modalBersihinRumah">
          <div class="icon-circle icon-home"><i class="bi bi-house"></i></div>
          <div>
            <div style="font-weight:700">Bersihin Rumah</div>
            <div class="small-note">Jasa bersih-bersih rumah</div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="category-card" data-bs-toggle="modal" data-bs-target="#modalBersihinKebun">
          <div class="icon-circle icon-garden"><i class="bi bi-tree"></i></div>
          <div>
            <div style="font-weight:700">Bersihin Kebun</div>
            <div class="small-note">Rapikan kebun / pangkas</div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="category-card" data-bs-toggle="modal" data-bs-target="#modalTempelBan">
          <div class="icon-circle icon-tire"><i class="bi bi-gear"></i></div>
          <div>
            <div style="font-weight:700">Tempel Ban</div>
            <div class="small-note">Tambal / ganti ban</div>
          </div>
        </div>
      </div>

    </div>

    <!-- Info / Footer small -->
    <div class="mt-4 small text-muted">
      <div><strong>Tarif:</strong> Rp6.000 / km. Pembulatan ke kelipatan 1000 (sisa < 500 → turun; ≥ 500 → naik).</div>
    </div>

  </div>

  <!-- ----------------- MODAL: ANTAR JEMPUT ----------------- -->
  <div class="modal fade" id="modalAntar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-bicycle"></i> Antar Jemput</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formAntar">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input class="form-control" name="name" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Lokasi Jemputan</label>
              <div class="d-flex gap-2">
                <button type="button" id="btnSetPickup" class="btn btn-outline-primary btn-large flex-grow-1">Set Lokasi Jemput (GPS / Map)</button>
                <span id="pickupShort" class="align-self-center small text-muted">Belum diset</span>
              </div>
              <input type="hidden" id="pickupLat" name="pickupLat">
              <input type="hidden" id="pickupLng" name="pickupLng">
            </div>

            <div class="mb-2">
              <label class="form-label">Tujuan Antar</label>
              <div class="d-flex gap-2">
                <button type="button" id="btnSetDrop" class="btn btn-outline-primary btn-large flex-grow-1">Set Lokasi Tujuan (GPS / Map)</button>
                <span id="dropShort" class="align-self-center small text-muted">Belum diset</span>
              </div>
              <small class="form-text text-muted">Atau ketik alamat tujuan pada kolom di bawah (opsional).</small>
              <input class="form-control mt-2" id="dropAddress" name="dropAddress" placeholder="Ketik alamat tujuan (opsional)">
              <input type="hidden" id="dropLat" name="dropLat">
              <input type="hidden" id="dropLng" name="dropLng">
            </div>

            <div class="mb-2">
              <label class="form-label">Estimasi Jarak & Tarif</label>
              <div class="p-2 border rounded">
                <div>Jarak: <span id="distanceKm">-</span> km</div>
                <div>Tarif kasar: <span id="rawFare">-</span></div>
                <div>Tarif setelah pembulatan: <strong id="roundedFare">-</strong></div>
                <div class="small text-muted mt-1">Tarif dasar: Rp6.000 / km</div>
              </div>
            </div>

            <div class="mt-3 d-grid">
              <button class="btn btn-success btn-large" type="button" id="sendAntar">Kirim Pesanan via WhatsApp</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ----------------- MODAL: KIRIM PAKET ----------------- -->
  <div class="modal fade" id="modalKirim" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-box-seam"></i> Kirim Paket</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formKirim">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input class="form-control" name="name" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Lokasi Pengirim (Set lokasi)</label>
              <div class="d-flex gap-2">
                <button type="button" id="btnSetPickup2" class="btn btn-outline-primary btn-large flex-grow-1">Set Lokasi (GPS / Map)</button>
                <span id="pickupShort2" class="align-self-center small text-muted">Belum diset</span>
              </div>
              <input type="hidden" id="pickupLat2" name="pickupLat">
              <input type="hidden" id="pickupLng2" name="pickupLng">
            </div>

            <div class="mb-2">
              <label class="form-label">Lokasi Tujuan (Set lokasi atau ketik)</label>
              <div class="d-flex gap-2">
                <button type="button" id="btnSetDrop2" class="btn btn-outline-primary btn-large flex-grow-1">Set Lokasi Tujuan (Map)</button>
                <span id="dropShort2" class="align-self-center small text-muted">Belum diset</span>
              </div>
              <input class="form-control mt-2" id="dropAddress2" name="dropAddress" placeholder="Ketik alamat tujuan (opsional)">
              <input type="hidden" id="dropLat2" name="dropLat">
              <input type="hidden" id="dropLng2" name="dropLng">
            </div>

            <div class="mb-2">
              <label class="form-label">Estimasi Jarak & Tarif</label>
              <div class="p-2 border rounded">
                <div>Jarak: <span id="distanceKm2">-</span> km</div>
                <div>Tarif kasar: <span id="rawFare2">-</span></div>
                <div>Tarif setelah pembulatan: <strong id="roundedFare2">-</strong></div>
              </div>
            </div>

            <div class="mt-3 d-grid">
              <button class="btn btn-success btn-large" type="button" id="sendKirim">Kirim Pesanan via WhatsApp</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ----------------- MODAL: BERSIHIN RUMAH ----------------- -->
  <div class="modal fade" id="modalBersihinRumah" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-house"></i> Bersihin Rumah</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formBersihRumah">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Alamat Lengkap</label>
              <input class="form-control" name="address" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Set Lokasi (GPS / Map)</label>
              <div class="d-flex gap-2">
                <button type="button" id="btnSetHouse" class="btn btn-outline-primary btn-large flex-grow-1">Set Lokasi</button>
                <span id="houseShort" class="align-self-center small text-muted">Belum diset</span>
              </div>
              <input type="hidden" id="houseLat" name="houseLat">
              <input type="hidden" id="houseLng" name="houseLng">
            </div>
            <div class="mb-2">
              <label class="form-label">Kolom kebutuhan Jasa</label>
              <textarea class="form-control" name="needs" rows="2" placeholder="Misal: vakum, lap lantai, cuci kamar mandi"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Pertanyaan Estimasi Biaya</label>
              <textarea class="form-control" name="question" rows="2" placeholder="Tulis pertanyaan untuk estimasi biaya"></textarea>
            </div>
            <div class="mt-3 d-grid">
              <button class="btn btn-success btn-large" type="button" id="sendBersihRumah">Kirim Pesanan via WhatsApp</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ----------------- MODAL: BERSIHIN KEBUN ----------------- -->
  <div class="modal fade" id="modalBersihinKebun" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-tree"></i> Bersihin Kebun</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formBersihKebun">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Alamat Lengkap</label>
              <input class="form-control" name="address" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Set Lokasi (GPS / Map)</label>
              <div class="d-flex gap-2">
                <button type="button" id="btnSetGarden" class="btn btn-outline-primary btn-large flex-grow-1">Set Lokasi</button>
                <span id="gardenShort" class="align-self-center small text-muted">Belum diset</span>
              </div>
              <input type="hidden" id="gardenLat" name="gardenLat">
              <input type="hidden" id="gardenLng" name="gardenLng">
            </div>
            <div class="mb-2">
              <label class="form-label">Kolom kebutuhan Jasa</label>
              <textarea class="form-control" name="needs" rows="2" placeholder="Misal: pangkas, buang sampah, rumput"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Pertanyaan Estimasi Biaya</label>
              <textarea class="form-control" name="question" rows="2"></textarea>
            </div>
            <div class="mt-3 d-grid">
              <button class="btn btn-success btn-large" type="button" id="sendBersihKebun">Kirim Pesanan via WhatsApp</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ----------------- MODAL: TEMPEL BAN ----------------- -->
  <div class="modal fade" id="modalTempelBan" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="bi bi-gear"></i> Tempel Ban</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formTempelBan">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input class="form-control" name="name" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Alamat Lengkap</label>
              <input class="form-control" name="address" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Set Lokasi (GPS / Map)</label>
              <div class="d-flex gap-2">
                <button type="button" id="btnSetTire" class="btn btn-outline-primary btn-large flex-grow-1">Set Lokasi</button>
                <span id="tireShort" class="align-self-center small text-muted">Belum diset</span>
              </div>
              <input type="hidden" id="tireLat" name="tireLat">
              <input type="hidden" id="tireLng" name="tireLng">
            </div>
            <div class="mb-2">
              <label class="form-label">Kolom kebutuhan Jasa</label>
              <textarea class="form-control" name="needs" rows="2" placeholder="Misal: tambal, ganti ban"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Pertanyaan Estimasi Biaya</label>
              <textarea class="form-control" name="question" rows="2"></textarea>
            </div>
            <div class="mt-3 d-grid">
              <button class="btn btn-success btn-large" type="button" id="sendTempelBan">Kirim Pesanan via WhatsApp</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- ----------------- MAP PICKER MODAL ----------------- -->
  <div class="modal fade" id="modalMap" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pilih Lokasi (Geser / Drag Pin)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div id="map"></div>
        </div>
        <div class="modal-footer">
          <div class="me-auto small text-muted">Seret pin untuk atur posisi. Mode: <span id="mapModeLabel">-</span></div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" id="confirmMap">Pilih Lokasi & Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- second map modal (for second pickers) -->
  <div class="modal fade" id="modalMap2" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pilih Lokasi (Geser / Drag Pin)</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div id="map2"></div>
        </div>
        <div class="modal-footer">
          <div class="me-auto small text-muted">Seret pin untuk atur posisi. Mode: <span id="map2ModeLabel">-</span></div>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
          <button class="btn btn-primary" id="confirmMap2">Pilih Lokasi & Simpan</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <button class="btn btn-light d-flex flex-column align-items-center" onclick="window.scrollTo({top:0,behavior:'smooth'})">
      <i class="bi bi-house-door-fill" style="font-size:1.2rem;color:var(--brand-green)"></i>
      <small>Home</small>
    </button>
    <button class="btn btn-light d-flex flex-column align-items-center" onclick="location.href='https://wa.me/6281262433533'">
      <i class="bi bi-question-circle-fill" style="font-size:1.2rem;color:var(--brand-orange)"></i>
      <small>Pertanyaan</small>
    </button>
    <button class="btn btn-light d-flex flex-column align-items-center" onclick="alert('Profil belum diimplementasikan')">
      <i class="bi bi-person-circle" style="font-size:1.2rem;color:#666"></i>
      <small>Profil</small>
    </button>
  </nav>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // Admin WhatsApp number
    const WA_ADMIN = '6281262433533';

    // helper: rounding rule to nearest 1000 with threshold 500
    function roundToThousand(amount){
      const rem = amount % 1000;
      if (rem < 500) return amount - rem;
      return amount + (1000 - rem);
    }

    // haversine distance in kilometers
    function haversine(lat1, lon1, lat2, lon2){
      if(!lat1||!lon1||!lat2||!lon2) return null;
      const R = 6371; // km
      const toRad = x => x * Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) +
                Math.cos(toRad(lat1))*Math.cos(toRad(lat2)) *
                Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R*c;
    }

    // prepare map pickers (we'll use two modal maps interchangeably)
    let map, marker;
    let map2, marker2;
    let currentMapMode = null; // store which field requested set (e.g., 'pickup','drop','house' etc)
    let currentMapMode2 = null;

    function initMap(){
      // map 1
      map = L.map('map', {zoomControl:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map);
      map.setView([0,0],2);
      marker = L.marker([0,0],{draggable:true}).addTo(map);

      // map 2
      map2 = L.map('map2', {zoomControl:true});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
      }).addTo(map2);
      map2.setView([0,0],2);
      marker2 = L.marker([0,0],{draggable:true}).addTo(map2);
    }

    // utility to open map modal and set mode
    function openMapModal(mode){
      currentMapMode = mode;
      document.getElementById('mapModeLabel').textContent = mode;
      const modal = new bootstrap.Modal(document.getElementById('modalMap'));
      // set initial view
      let lat=0,lng=0;
      // try load existing coords based on mode
      if(mode === 'pickup'){
        lat = parseFloat(document.getElementById('pickupLat').value) || null;
        lng = parseFloat(document.getElementById('pickupLng').value) || null;
      } else if(mode === 'drop'){
        lat = parseFloat(document.getElementById('dropLat').value) || null;
        lng = parseFloat(document.getElementById('dropLng').value) || null;
      } else if(mode === 'house'){
        lat = parseFloat(document.getElementById('houseLat').value) || null;
        lng = parseFloat(document.getElementById('houseLng').value) || null;
      } else if(mode === 'garden'){
        lat = parseFloat(document.getElementById('gardenLat').value) || null;
        lng = parseFloat(document.getElementById('gardenLng').value) || null;
      } else if(mode === 'tire'){
        lat = parseFloat(document.getElementById('tireLat').value) || null;
        lng = parseFloat(document.getElementById('tireLng').value) || null;
      }

      if(lat && lng){
        map.setView([lat,lng],16);
        marker.setLatLng([lat,lng]);
      } else {
        // try geolocation
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos=>{
            const p = [pos.coords.latitude,pos.coords.longitude];
            map.setView(p,16);
            marker.setLatLng(p);
          }, err=>{
            // fallback world view
            map.setView([0,0],2);
          });
        } else {
          map.setView([0,0],2);
        }
      }
      modal.show();
    }

    function openMapModal2(mode){
      currentMapMode2 = mode;
      document.getElementById('map2ModeLabel').textContent = mode;
      const modal = new bootstrap.Modal(document.getElementById('modalMap2'));
      let lat=0,lng=0;
      if(mode === 'pickup2'){
        lat = parseFloat(document.getElementById('pickupLat2').value) || null;
        lng = parseFloat(document.getElementById('pickupLng2').value) || null;
      } else if(mode === 'drop2'){
        lat = parseFloat(document.getElementById('dropLat2').value) || null;
        lng = parseFloat(document.getElementById('dropLng2').value) || null;
      }
      if(lat && lng){
        map2.setView([lat,lng],16);
        marker2.setLatLng([lat,lng]);
      } else {
        if(navigator.geolocation){
          navigator.geolocation.getCurrentPosition(pos=>{
            const p = [pos.coords.latitude,pos.coords.longitude];
            map2.setView(p,16);
            marker2.setLatLng(p);
          }, err=>{
            map2.setView([0,0],2);
          });
        } else {
          map2.setView([0,0],2);
        }
      }
      modal.show();
    }

    // confirm buttons
    document.addEventListener('DOMContentLoaded', function(){
      initMap();

      document.getElementById('btnSetPickup').addEventListener('click', ()=>openMapModal('pickup'));
      document.getElementById('btnSetDrop').addEventListener('click', ()=>openMapModal('drop'));
      document.getElementById('btnSetHouse').addEventListener('click', ()=>openMapModal('house'));
      document.getElementById('btnSetGarden').addEventListener('click', ()=>openMapModal('garden'));
      document.getElementById('btnSetTire').addEventListener('click', ()=>openMapModal('tire'));

      document.getElementById('btnSetPickup2').addEventListener('click', ()=>openMapModal2('pickup2'));
      document.getElementById('btnSetDrop2').addEventListener('click', ()=>openMapModal2('drop2'));

      document.getElementById('confirmMap').addEventListener('click', ()=>{
        const pos = marker.getLatLng();
        if(!currentMapMode) return;
        savePickedLocation(currentMapMode, pos.lat, pos.lng);
        bootstrap.Modal.getInstance(document.getElementById('modalMap')).hide();
      });

      document.getElementById('confirmMap2').addEventListener('click', ()=>{
        const pos = marker2.getLatLng();
        if(!currentMapMode2) return;
        savePickedLocation2(currentMapMode2, pos.lat, pos.lng);
        bootstrap.Modal.getInstance(document.getElementById('modalMap2')).hide();
      });

      // when map modal shown, invalidate size
      document.getElementById('modalMap').addEventListener('shown.bs.modal', ()=>{ map.invalidateSize(); });
      document.getElementById('modalMap2').addEventListener('shown.bs.modal', ()=>{ map2.invalidateSize(); });

      // send antar
      document.getElementById('sendAntar').addEventListener('click', sendAntarViaWA);
      document.getElementById('sendKirim').addEventListener('click', sendKirimViaWA);
      document.getElementById('sendBersihRumah').addEventListener('click', sendBersihRumahViaWA);
      document.getElementById('sendBersihKebun').addEventListener('click', sendBersihKebunViaWA);
      document.getElementById('sendTempelBan').addEventListener('click', sendTempelBanViaWA);

      // recalc whenever drop/pick inputs change
      ['pickupLat','pickupLng','dropLat','dropLng'].forEach(id => {
        document.getElementById(id).addEventListener('change', recalcAntar);
      });
      ['pickupLat2','pickupLng2','dropLat2','dropLng2'].forEach(id => {
        document.getElementById(id).addEventListener('change', recalcKirim);
      });

      // also allow manual address entry to show link (not geocoded)
      document.getElementById('dropAddress').addEventListener('input', ()=>{ if(!document.getElementById('dropLat').value) document.getElementById('dropShort').textContent = document.getElementById('dropAddress').value ? 'Alamat tertulis' : 'Belum diset';});
      document.getElementById('dropAddress2').addEventListener('input', ()=>{ if(!document.getElementById('dropLat2').value) document.getElementById('dropShort2').textContent = document.getElementById('dropAddress2').value ? 'Alamat tertulis' : 'Belum diset';});

    });

    function savePickedLocation(mode, lat, lng){
      if(mode === 'pickup'){
        document.getElementById('pickupLat').value = lat;
        document.getElementById('pickupLng').value = lng;
        document.getElementById('pickupShort').innerHTML = `<a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}" target="_blank">Lokasi dipilih</a>`;
      } else if(mode === 'drop'){
        document.getElementById('dropLat').value = lat;
        document.getElementById('dropLng').value = lng;
        document.getElementById('dropShort').innerHTML = `<a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}" target="_blank">Lokasi dipilih</a>`;
      } else if(mode === 'house'){
        document.getElementById('houseLat').value = lat;
        document.getElementById('houseLng').value = lng;
        document.getElementById('houseShort').innerHTML = `<a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}" target="_blank">Lokasi dipilih</a>`;
      } else if(mode === 'garden'){
        document.getElementById('gardenLat').value = lat;
        document.getElementById('gardenLng').value = lng;
        document.getElementById('gardenShort').innerHTML = `<a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}" target="_blank">Lokasi dipilih</a>`;
      } else if(mode === 'tire'){
        document.getElementById('tireLat').value = lat;
        document.getElementById('tireLng').value = lng;
        document.getElementById('tireShort').innerHTML = `<a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}" target="_blank">Lokasi dipilih</a>`;
      }
      recalcAntar();
    }

    function savePickedLocation2(mode, lat, lng){
      if(mode === 'pickup2'){
        document.getElementById('pickupLat2').value = lat;
        document.getElementById('pickupLng2').value = lng;
        document.getElementById('pickupShort2').innerHTML = `<a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}" target="_blank">Lokasi dipilih</a>`;
      } else if(mode === 'drop2'){
        document.getElementById('dropLat2').value = lat;
        document.getElementById('dropLng2').value = lng;
        document.getElementById('dropShort2').innerHTML = `<a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}" target="_blank">Lokasi dipilih</a>`;
      }
      recalcKirim();
    }

    // recalculations
    function recalcAntar(){
      const plat = parseFloat(document.getElementById('pickupLat').value);
      const plng = parseFloat(document.getElementById('pickupLng').value);
      const dlat = parseFloat(document.getElementById('dropLat').value);
      const dlng = parseFloat(document.getElementById('dropLng').value);

      if(plat && plng && dlat && dlng){
        const km = haversine(plat,plng,dlat,dlng);
        const kmFixed = Math.round(km*100)/100;
        document.getElementById('distanceKm').textContent = kmFixed.toLocaleString('id-ID', {minimumFractionDigits:2, maximumFractionDigits:2});
        const raw = Math.round(km * 6000);
        document.getElementById('rawFare').textContent = 'Rp' + raw.toLocaleString('id-ID');
        document.getElementById('roundedFare').textContent = 'Rp' + roundToThousand(raw).toLocaleString('id-ID');
      }
    }

    function recalcKirim(){
      const plat = parseFloat(document.getElementById('pickupLat2').value);
      const plng = parseFloat(document.getElementById('pickupLng2').value);
      const dlat = parseFloat(document.getElementById('dropLat2').value);
      const dlng = parseFloat(document.getElementById('dropLng2').value);

      if(plat && plng && dlat && dlng){
        const km = haversine(plat,plng,dlat,dlng);
        const kmFixed = Math.round(km*100)/100;
        document.getElementById('distanceKm2').textContent = kmFixed.toLocaleString('id-ID', {minimumFractionDigits:2, maximumFractionDigits:2});
        const raw = Math.round(km * 6000);
        document.getElementById('rawFare2').textContent = 'Rp' + raw.toLocaleString('id-ID');
        document.getElementById('roundedFare2').textContent = 'Rp' + roundToThousand(raw).toLocaleString('id-ID');
      }
    }

    // build WhatsApp message helpers
    function makeOSMLink(lat, lng){
      if(!lat || !lng) return '';
      return `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=18/${lat}/${lng}`;
    }

    function sendAntarViaWA(){
      const name = document.querySelector('#formAntar [name="name"]').value || '-';
      const plat = document.getElementById('pickupLat').value;
      const plng = document.getElementById('pickupLng').value;
      const dlat = document.getElementById('dropLat').value;
      const dlng = document.getElementById('dropLng').value;
      const dropAddress = document.getElementById('dropAddress').value || '';
      const distance = document.getElementById('distanceKm').textContent || '-';
      const fare = document.getElementById('roundedFare').textContent || '-';

      if(!plat || !plng || (!dlat && !dropAddress)){
        alert('Mohon set lokasi jemput dan tujuan (bisa set di peta atau ketik alamat tujuan).');
        return;
      }

      const pickupLink = makeOSMLink(plat,plng);
      let dropLink = dlat && dlng ? makeOSMLink(dlat,dlng) : '';
      let msg = `*Pesanan - Jasa Antar*%0A`;
      msg += `Nama: ${encodeURIComponent(name)}%0A`;
      msg += `Lokasi Jemput: ${pickupLink ? pickupLink : 'terlampir'}%0A`;
      if(dropLink) msg += `Lokasi Tujuan: ${dropLink}%0A`;
      else if(dropAddress) msg += `Alamat Tujuan: ${encodeURIComponent(dropAddress)}%0A`;
      msg += `Estimasi Jarak: ${distance} km%0A`;
      msg += `Estimasi Tarif: ${fare}%0A`;
      msg += `%0A*Catatan:* Saya memesan lewat aplikasi SiapSuruh.`;

      const url = `https://wa.me/${WA_ADMIN}?text=${msg}`;
      window.open(url, '_blank');
    }

    function sendKirimViaWA(){
      const name = document.querySelector('#formKirim [name="name"]').value || '-';
      const plat = document.getElementById('pickupLat2').value;
      const plng = document.getElementById('pickupLng2').value;
      const dlat = document.getElementById('dropLat2').value;
      const dlng = document.getElementById('dropLng2').value;
      const dropAddress = document.getElementById('dropAddress2').value || '';
      const distance = document.getElementById('distanceKm2').textContent || '-';
      const fare = document.getElementById('roundedFare2').textContent || '-';

      if(!plat || !plng || (!dlat && !dropAddress)){
        alert('Mohon set lokasi pengirim dan tujuan (peta atau ketik alamat tujuan).');
        return;
      }

      const pickupLink = makeOSMLink(plat,plng);
      let dropLink = dlat && dlng ? makeOSMLink(dlat,dlng) : '';
      let msg = `*Pesanan - Kirim Paket*%0A`;
      msg += `Nama: ${encodeURIComponent(name)}%0A`;
      msg += `Lokasi Pengirim: ${pickupLink ? pickupLink : 'terlampir'}%0A`;
      if(dropLink) msg += `Lokasi Tujuan: ${dropLink}%0A`;
      else if(dropAddress) msg += `Alamat Tujuan: ${encodeURIComponent(dropAddress)}%0A`;
      msg += `Estimasi Jarak: ${distance} km%0A`;
      msg += `Estimasi Tarif: ${fare}%0A`;
      msg += `%0A*Catatan:* Kirim paket via SiapSuruh.`;

      const url = `https://wa.me/${WA_ADMIN}?text=${msg}`;
      window.open(url, '_blank');
    }

    function sendBersihRumahViaWA(){
      const form = document.getElementById('formBersihRumah');
      const name = form.querySelector('[name="name"]').value || '-';
      const address = form.querySelector('[name="address"]').value || '-';
      const lat = document.getElementById('houseLat').value;
      const lng = document.getElementById('houseLng').value;
      const needs = form.querySelector('[name="needs"]').value || '-';
      const question = form.querySelector('[name="question"]').value || '';

      if(!address){
        alert('Mohon isi alamat lengkap.');
        return;
      }

      let msg = `*Pesanan - Bersihin Rumah*%0A`;
      msg += `Nama: ${encodeURIComponent(name)}%0A`;
      msg += `Alamat: ${encodeURIComponent(address)}%0A`;
      if(lat && lng) msg += `Lokasi: ${makeOSMLink(lat,lng)}%0A`;
      msg += `Kebutuhan: ${encodeURIComponent(needs)}%0A`;
      if(question) msg += `Tanya: ${encodeURIComponent(question)}%0A`;
      msg += `%0A*Catatan:* Pesanan via SiapSuruh.`;

      const url = `https://wa.me/${WA_ADMIN}?text=${msg}`;
      window.open(url, '_blank');
    }

    function sendBersihKebunViaWA(){
      const form = document.getElementById('formBersihKebun');
      const name = form.querySelector('[name="name"]').value || '-';
      const address = form.querySelector('[name="address"]').value || '-';
      const lat = document.getElementById('gardenLat').value;
      const lng = document.getElementById('gardenLng').value;
      const needs = form.querySelector('[name="needs"]').value || '-';
      const question = form.querySelector('[name="question"]').value || '';

      if(!address){
        alert('Mohon isi alamat lengkap.');
        return;
      }

      let msg = `*Pesanan - Bersihin Kebun*%0A`;
      msg += `Nama: ${encodeURIComponent(name)}%0A`;
      msg += `Alamat: ${encodeURIComponent(address)}%0A`;
      if(lat && lng) msg += `Lokasi: ${makeOSMLink(lat,lng)}%0A`;
      msg += `Kebutuhan: ${encodeURIComponent(needs)}%0A`;
      if(question) msg += `Tanya: ${encodeURIComponent(question)}%0A`;
      msg += `%0A*Catatan:* Pesanan via SiapSuruh.`;

      const url = `https://wa.me/${WA_ADMIN}?text=${msg}`;
      window.open(url, '_blank');
    }

    function sendTempelBanViaWA(){
      const form = document.getElementById('formTempelBan');
      const name = form.querySelector('[name="name"]').value || '-';
      const address = form.querySelector('[name="address"]').value || '-';
      const lat = document.getElementById('tireLat').value;
      const lng = document.getElementById('tireLng').value;
      const needs = form.querySelector('[name="needs"]').value || '-';
      const question = form.querySelector('[name="question"]').value || '';

      if(!address){
        alert('Mohon isi alamat lengkap.');
        return;
      }

      let msg = `*Pesanan - Tempel Ban*%0A`;
      msg += `Nama: ${encodeURIComponent(name)}%0A`;
      msg += `Alamat: ${encodeURIComponent(address)}%0A`;
      if(lat && lng) msg += `Lokasi: ${makeOSMLink(lat,lng)}%0A`;
      msg += `Kebutuhan: ${encodeURIComponent(needs)}%0A`;
      if(question) msg += `Tanya: ${encodeURIComponent(question)}%0A`;
      msg += `%0A*Catatan:* Pesanan via SiapSuruh.`;

      const url = `https://wa.me/${WA_ADMIN}?text=${msg}`;
      window.open(url, '_blank');
    }

    // keep marker synced to clicks: when user clicks map, move marker
    function attachMapClickHandlers(){
      map.on('click', function(e){ marker.setLatLng(e.latlng); });
      map2.on('click', function(e){ marker2.setLatLng(e.latlng); });
    }
    // attach after init
    setTimeout(attachMapClickHandlers, 600);

    // set initial center using geolocation (best effort)
    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(pos=>{
        const lat = pos.coords.latitude, lng = pos.coords.longitude;
        if(map) map.setView([lat,lng],13);
        if(map2) map2.setView([lat,lng],13);
      });
    }

  </script>
</body>
</html>
