<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SIAP SURUH, SIAP ANTAR</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{--green:#2db84c;--orange:#ff8a00;--white:#ffffff;}
    body{background:linear-gradient(180deg,#eaffea,#fff7ec);font-family:system-ui,Segoe UI,Roboto,Arial;margin-bottom:92px;}
    .top-banner{background:linear-gradient(90deg,var(--green),var(--orange));color:#fff;padding:16px;border-radius:0 0 14px 14px}
    .category-row{display:flex;gap:10px;overflow-x:auto;padding:12px}
    .cat-card{min-width:120px;background:#fff;border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,0.06);padding:12px;text-align:center;cursor:pointer}
    .icon-box{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:#fff;margin:0 auto 6px}
    .bottom-nav{position:fixed;left:12px;right:12px;bottom:12px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,0.08);padding:8px;display:flex;justify-content:space-around;z-index:999}
    .map-full{height:60vh;border-radius:8px}
    .small-link{font-size:0.85rem;word-break:break-all}
    .tarif-box{background:#fff;border-radius:10px;padding:10px;box-shadow:0 6px 14px rgba(0,0,0,0.04)}
    .btn-green{background:var(--green);color:#fff;border:0}
    .btn-orange{background:var(--orange);color:#fff;border:0}
  </style>
</head>
<body>

  <div class="container-fluid px-3">
    <div class="top-banner text-center">
      <h4 class="mb-0">SIAP SURUH, SIAP ANTAR</h4>
      <small>layanan suruhan & antar cepat</small>
    </div>

    <div class="mt-3">
      <div class="category-row">
        <div class="cat-card" data-bs-toggle="modal" data-bs-target="#modalAntar">
          <div class="icon-box"><i class="bi bi-bicycle" style="font-size:22px;color:var(--green)"></i></div>
          <div class="fw-bold">Jasa Antar</div>
          <small class="text-muted">Antar jemput</small>
        </div>

        <div class="cat-card" data-bs-toggle="modal" data-bs-target="#modalKirim">
          <div class="icon-box"><i class="bi bi-box-seam" style="font-size:22px;color:var(--orange)"></i></div>
          <div class="fw-bold">Kirim Paket</div>
          <small class="text-muted">Kirim barang</small>
        </div>

        <div class="cat-card" data-bs-toggle="modal" data-bs-target="#modalBersihRumah">
          <div class="icon-box"><i class="bi bi-house" style="font-size:22px;color:var(--green)"></i></div>
          <div class="fw-bold">Bersihin Rumah</div>
        </div>

        <div class="cat-card" data-bs-toggle="modal" data-bs-target="#modalBersihKebun">
          <div class="icon-box"><i class="bi bi-tree-fill" style="font-size:22px;color:var(--green)"></i></div>
          <div class="fw-bold">Bersihin Kebun</div>
        </div>

        <div class="cat-card" data-bs-toggle="modal" data-bs-target="#modalTempelBan">
          <div class="icon-box"><i class="bi bi-tools" style="font-size:22px;color:var(--orange)"></i></div>
          <div class="fw-bold">Tempel Ban</div>
        </div>
      </div>

      <div class="mt-3 px-1">
        <div class="tarif-box">
          <div class="fw-semibold">Informasi Tarif</div>
          <div class="small text-muted">
            Tarif: <strong>6.000 IDR / km</strong>. Pembulatan ke 1.000 terdekat:
            jika sisa <strong>&lt; 500</strong> dibulatkan ke bawah, jika sisa <strong>‚â• 500</strong> dibulatkan ke atas.
            (Contoh: 4.450 ‚Üí 4.000 ; 4.560 ‚Üí 5.000)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom nav (Home, Pertanyaan, Profil) -->
  <div class="bottom-nav">
    <div class="text-center">
      <div class="fs-4">üè†</div><small>Home</small>
    </div>
    <div class="text-center">
      <div class="fs-4">‚ùì</div><small>Pertanyaan</small>
    </div>
    <div class="text-center">
      <div class="fs-4">üë§</div><small>Profil</small>
    </div>
  </div>

  <!-- Modals -->

  <!-- Antar / Jemput -->
  <div class="modal fade" id="modalAntar" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Form Antar Jemput</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formAntar" onsubmit="return false;">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input id="antar_nama" class="form-control" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Lokasi Jemputan</label>
              <div class="input-group">
                <input id="antar_jemput" class="form-control" placeholder="Belum diset (klik Set lokasi)" readonly>
                <button type="button" class="btn btn-outline-secondary" onclick="openMapSetter('antar_jemput')">Set lokasi</button>
              </div>
              <div class="form-text small">Hasil lokasi akan berupa URL (klik untuk buka).</div>
            </div>

            <div class="mb-2">
              <label class="form-label">Tujuan Antar</label>
              <div class="input-group">
                <input id="antar_tujuan" class="form-control" placeholder="Ketik alamat atau Set lokasi">
                <button type="button" class="btn btn-outline-secondary" onclick="openMapSetter('antar_tujuan')">Set lokasi</button>
              </div>
              <div class="form-text small">Anda dapat mengetik alamat atau set dari peta.</div>
            </div>

            <div class="mb-2">
              <label class="form-label">Estimasi Jarak</label>
              <input id="antar_estimasi" class="form-control" readonly placeholder="-">
            </div>

            <div class="mb-2">
              <label class="form-label">Tarif</label>
              <input id="antar_tarif" class="form-control" readonly placeholder="-">
            </div>

            <div class="d-grid gap-2 mt-2">
              <button id="antar_send" type="button" class="btn btn-green" onclick="sendOrder('antar')">
                <i class="bi bi-whatsapp"></i> Kirim Pesanan via WhatsApp
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Kirim Paket -->
  <div class="modal fade" id="modalKirim" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Form Kirim Paket</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formKirim" onsubmit="return false;">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input id="kirim_nama" class="form-control" required>
            </div>

            <div class="mb-2">
              <label class="form-label">Lokasi Pengirim</label>
              <div class="input-group">
                <input id="kirim_pengirim" class="form-control" readonly placeholder="Belum diset">
                <button type="button" class="btn btn-outline-secondary" onclick="openMapSetter('kirim_pengirim')">Set lokasi</button>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label">Lokasi Penerima</label>
              <div class="input-group">
                <input id="kirim_penerima" class="form-control" placeholder="Ketik alamat atau Set lokasi">
                <button type="button" class="btn btn-outline-secondary" onclick="openMapSetter('kirim_penerima')">Set lokasi</button>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label">Estimasi Jarak</label>
              <input id="kirim_estimasi" class="form-control" readonly placeholder="-">
            </div>

            <div class="mb-2">
              <label class="form-label">Tarif</label>
              <input id="kirim_tarif" class="form-control" readonly placeholder="-">
            </div>

            <div class="d-grid gap-2 mt-2">
              <button type="button" class="btn btn-orange" onclick="sendOrder('kirim')">
                <i class="bi bi-whatsapp"></i> Kirim Pesanan via WhatsApp
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bersihin Rumah -->
  <div class="modal fade" id="modalBersihRumah" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Form Bersihin Rumah</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="formBersihRumah" onsubmit="return false;">
            <div class="mb-2"><label class="form-label">Nama</label><input id="rumah_nama" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Alamat Lengkap</label><input id="rumah_alamat" class="form-control"></div>
            <div class="mb-2">
              <label class="form-label">Set Lokasi</label>
              <div class="input-group">
                <input id="rumah_lokasi" class="form-control" readonly placeholder="Belum diset">
                <button type="button" class="btn btn-outline-secondary" onclick="openMapSetter('rumah_lokasi')">Set lokasi</button>
              </div>
            </div>
            <div class="mb-2"><label class="form-label">Kebutuhan Jasa</label><textarea id="rumah_kebutuhan" class="form-control"></textarea></div>
            <div class="mb-2"><label class="form-label">Pertanyaan Estimasi Biaya</label><textarea id="rumah_pertanyaan" class="form-control"></textarea></div>
            <div class="d-grid gap-2 mt-2"><button class="btn btn-green" type="button" onclick="sendOrder('rumah')"><i class="bi bi-whatsapp"></i> Kirim Pesanan via WhatsApp</button></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bersihin Kebun -->
  <div class="modal fade" id="modalBersihKebun" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Form Bersihin Kebun</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="formBersihKebun" onsubmit="return false;">
            <div class="mb-2"><label class="form-label">Nama</label><input id="kebun_nama" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Alamat Lengkap</label><input id="kebun_alamat" class="form-control"></div>
            <div class="mb-2">
              <label class="form-label">Set Lokasi</label>
              <div class="input-group">
                <input id="kebun_lokasi" class="form-control" readonly placeholder="Belum diset">
                <button type="button" class="btn btn-outline-secondary" onclick="openMapSetter('kebun_lokasi')">Set lokasi</button>
              </div>
            </div>
            <div class="mb-2"><label class="form-label">Kebutuhan Jasa</label><textarea id="kebun_kebutuhan" class="form-control"></textarea></div>
            <div class="mb-2"><label class="form-label">Pertanyaan Estimasi Biaya</label><textarea id="kebun_pertanyaan" class="form-control"></textarea></div>
            <div class="d-grid gap-2 mt-2"><button class="btn btn-green" type="button" onclick="sendOrder('kebun')"><i class="bi bi-whatsapp"></i> Kirim Pesanan via WhatsApp</button></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Tempel Ban -->
  <div class="modal fade" id="modalTempelBan" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header"><h5 class="modal-title">Form Tempel Ban</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body">
          <form id="formTempelBan" onsubmit="return false;">
            <div class="mb-2"><label class="form-label">Nama</label><input id="ban_nama" class="form-control"></div>
            <div class="mb-2"><label class="form-label">Alamat Lengkap</label><input id="ban_alamat" class="form-control"></div>
            <div class="mb-2">
              <label class="form-label">Set Lokasi</label>
              <div class="input-group">
                <input id="ban_lokasi" class="form-control" readonly placeholder="Belum diset">
                <button type="button" class="btn btn-outline-secondary" onclick="openMapSetter('ban_lokasi')">Set lokasi</button>
              </div>
            </div>
            <div class="mb-2"><label class="form-label">Kebutuhan Jasa</label><textarea id="ban_kebutuhan" class="form-control"></textarea></div>
            <div class="mb-2"><label class="form-label">Pertanyaan Estimasi Biaya</label><textarea id="ban_pertanyaan" class="form-control"></textarea></div>
            <div class="d-grid gap-2 mt-2"><button class="btn btn-green" type="button" onclick="sendOrder('ban')"><i class="bi bi-whatsapp"></i> Kirim Pesanan via WhatsApp</button></div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Map modal (Leaflet) -->
  <div class="modal fade" id="mapModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pilih Lokasi pada Peta</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div id="map" class="map-full"></div>
        </div>
        <div class="modal-footer">
          <button id="use-current-pos" type="button" class="btn btn-outline-secondary">Gunakan Lokasi Saat Ini (GPS)</button>
          <button id="save-map-pos" type="button" class="btn btn-primary">Simpan Lokasi</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // ADMIN WA number (no plus sign)
    const ADMIN_WA = '6281262433533';

    // Map and selection state
    let mapInstance = null;
    let tempMarker = null;
    let currentTargetInputId = null; // the input that we are setting (e.g., 'antar_jemput', 'antar_tujuan', 'kirim_pengirim' ...)
    const positionStore = {}; // store lat/lng per input id, e.g., { 'antar_jemput': {lat:...,lng:...}, ... }

    // Initialize leaflet when map modal shown
    const mapModalEl = document.getElementById('mapModal');
    mapModalEl.addEventListener('shown.bs.modal', initializeMap);

    function initializeMap() {
      if (mapInstance) return;
      // center default at Jakarta (can change)
      mapInstance = L.map('map').setView([-6.200000,106.816666], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(mapInstance);

      // click to add/move marker
      mapInstance.on('click', function(e){
        placeTempMarker(e.latlng);
      });

      // buttons
      document.getElementById('use-current-pos').addEventListener('click', useCurrentPosition);
      document.getElementById('save-map-pos').addEventListener('click', saveMapPosition);
    }

    function placeTempMarker(latlng){
      if(tempMarker) mapInstance.removeLayer(tempMarker);
      tempMarker = L.marker(latlng, {draggable:true}).addTo(mapInstance);
      tempMarker.on('dragend', function(){ /* nothing extra, keep new coords */ });
    }

    async function useCurrentPosition(){
      if(!navigator.geolocation){
        alert('Geolocation tidak didukung oleh browser Anda.');
        return;
      }
      navigator.geolocation.getCurrentPosition(function(pos){
        const latlng = {lat: pos.coords.latitude, lng: pos.coords.longitude};
        mapInstance.setView(latlng, 16);
        placeTempMarker(latlng);
      }, function(err){
        alert('Tidak dapat mendapatkan lokasi: ' + err.message);
      }, {enableHighAccuracy:true, timeout:10000});
    }

    function saveMapPosition(){
      if(!currentTargetInputId){
        alert('Tidak ada field yang dipilih untuk diset.');
        return;
      }
      if(!tempMarker){
        alert('Silakan pilih titik di peta (klik) atau gunakan lokasi saat ini.');
        return;
      }
      const latlng = tempMarker.getLatLng();
      // store
      positionStore[currentTargetInputId] = {lat: latlng.lat, lng: latlng.lng};
      // make OSM url
      const url = `https://www.openstreetmap.org/?mlat=${latlng.lat.toFixed(6)}&mlon=${latlng.lng.toFixed(6)}#map=18/${latlng.lat.toFixed(6)}/${latlng.lng.toFixed(6)}`;
      // set input value to clickable url (we store as text; admin can click)
      const inputEl = document.getElementById(currentTargetInputId);
      if(inputEl){
        inputEl.value = url;
      }
      // hide modal
      const modal = bootstrap.Modal.getInstance(mapModalEl);
      modal.hide();

      // after setting, try compute estimations
      computeEstimationsForRelevantForms();
    }

    // open map setter for a particular input id
    function openMapSetter(inputId){
      currentTargetInputId = inputId;
      // center map on existing pos if available
      const pos = positionStore[inputId];
      const modal = new bootstrap.Modal(mapModalEl);
      modal.show();
      // ensure map is ready (small timeout helps when first opened)
      setTimeout(() => {
        if(mapInstance){
          if(pos) mapInstance.setView([pos.lat,pos.lng], 16);
          else mapInstance.setView([-6.200000,106.816666], 13);
          // if there was a previously stored marker for this input, place it
          if(pos){
            placeTempMarker(pos);
          } else {
            if(tempMarker){ mapInstance.removeLayer(tempMarker); tempMarker = null; }
          }
        }
      }, 200);
    }

    // ---------- Distance & Tarif calculation ----------
    // haversine formula returns km
    function haversineKm(lat1, lon1, lat2, lon2){
      const R = 6371; // Earth's radius in km
      const toRad = d => d * Math.PI / 180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Tarif rules: 6000 IDR / km. Rounding: to nearest 1000 with threshold 500:
    // remainder < 500 -> round down to lower 1000; remainder >= 500 -> round up to next 1000.
    function calcTarifFromKm(km){
      const perKm = 6000;
      const raw = Math.round(km * perKm); // raw in IDR
      const remainder = raw % 1000;
      let base = raw - remainder;
      if(remainder >= 500) base += 1000;
      // ensure minimum maybe? (not specified) so return base
      return base;
    }

    // compute estimations for antar & kirim when positions available
    function computeEstimationsForRelevantForms(){
      // ANTAR: need antar_jemput and antar_tujuan OR if antar_tujuan typed as URL, we don't have coords -> only compute if both coords exist in positionStore
      if(positionStore['antar_jemput'] && positionStore['antar_tujuan']){
        const a = positionStore['antar_jemput'];
        const b = positionStore['antar_tujuan'];
        const dist = haversineKm(a.lat, a.lng, b.lat, b.lng);
        const tarif = calcTarifFromKm(dist);
        document.getElementById('antar_estimasi').value = dist.toFixed(2) + ' km';
        document.getElementById('antar_tarif').value = 'Rp ' + tarif.toLocaleString('id-ID');
      } else {
        // clear if not ready
        if(!positionStore['antar_jemput'] || !positionStore['antar_tujuan']){
          document.getElementById('antar_estimasi').value = '';
          document.getElementById('antar_tarif').value = '';
        }
      }

      // KIRIM: need kirim_pengirim & kirim_penerima coords
      if(positionStore['kirim_pengirim'] && positionStore['kirim_penerima']){
        const a = positionStore['kirim_pengirim'];
        const b = positionStore['kirim_penerima'];
        const dist = haversineKm(a.lat, a.lng, b.lat, b.lng);
        const tarif = calcTarifFromKm(dist);
        document.getElementById('kirim_estimasi').value = dist.toFixed(2) + ' km';
        document.getElementById('kirim_tarif').value = 'Rp ' + tarif.toLocaleString('id-ID');
      } else {
        if(!positionStore['kirim_pengirim'] || !positionStore['kirim_penerima']){
          document.getElementById('kirim_estimasi').value = '';
          document.getElementById('kirim_tarif').value = '';
        }
      }
    }

    // also allow user to type a "destination url" manually and admin to click; but automatic tarif only available when both coords set via map
    // Optionally if user types a textual address into antar_tujuan or kirim_penerima, there is no coord for distance calc.

    // ---------- WhatsApp sending ----------
    function sendOrder(type){
      let text = '';
      if(type === 'antar'){
        const nama = document.getElementById('antar_nama').value || '-';
        const jemput = document.getElementById('antar_jemput').value || '-';
        const tujuan = document.getElementById('antar_tujuan').value || '-';
        const estim = document.getElementById('antar_estimasi').value || '-';
        const tarif = document.getElementById('antar_tarif').value || '-';
        text = `Pesanan Antar%0AName: ${encodeURIComponent(nama)}%0ALokasi Jemput: ${encodeURIComponent(jemput)}%0ALokasi Tujuan: ${encodeURIComponent(tujuan)}%0AEstimasi: ${encodeURIComponent(estim)}%0ATarif: ${encodeURIComponent(tarif)}`;
      } else if(type === 'kirim'){
        const nama = document.getElementById('kirim_nama').value || '-';
        const pengirim = document.getElementById('kirim_pengirim').value || '-';
        const penerima = document.getElementById('kirim_penerima').value || '-';
        const estim = document.getElementById('kirim_estimasi').value || '-';
        const tarif = document.getElementById('kirim_tarif').value || '-';
        text = `Pesanan Kirim Paket%0AName: ${encodeURIComponent(nama)}%0ALokasi Pengirim: ${encodeURIComponent(pengirim)}%0ALokasi Penerima: ${encodeURIComponent(penerima)}%0AEstimasi: ${encodeURIComponent(estim)}%0ATarif: ${encodeURIComponent(tarif)}`;
      } else if(type === 'rumah'){
        const nama = document.getElementById('rumah_nama').value || '-';
        const alamat = document.getElementById('rumah_alamat').value || '-';
        const lokasi = document.getElementById('rumah_lokasi').value || '-';
        const kebutuhan = document.getElementById('rumah_kebutuhan').value || '-';
        const pertanyaan = document.getElementById('rumah_pertanyaan').value || '-';
        text = `Pesanan Bersihin Rumah%0AName: ${encodeURIComponent(nama)}%0AAlamat: ${encodeURIComponent(alamat)}%0ALokasi: ${encodeURIComponent(lokasi)}%0AKebutuhan: ${encodeURIComponent(kebutuhan)}%0APertanyaan: ${encodeURIComponent(pertanyaan)}`;
      } else if(type === 'kebun'){
        const nama = document.getElementById('kebun_nama').value || '-';
        const alamat = document.getElementById('kebun_alamat').value || '-';
        const lokasi = document.getElementById('kebun_lokasi').value || '-';
        const kebutuhan = document.getElementById('kebun_kebutuhan').value || '-';
        const pertanyaan = document.getElementById('kebun_pertanyaan').value || '-';
        text = `Pesanan Bersihin Kebun%0AName: ${encodeURIComponent(nama)}%0AAlamat: ${encodeURIComponent(alamat)}%0ALokasi: ${encodeURIComponent(lokasi)}%0AKebutuhan: ${encodeURIComponent(kebutuhan)}%0APertanyaan: ${encodeURIComponent(pertanyaan)}`;
      } else if(type === 'ban'){
        const nama = document.getElementById('ban_nama').value || '-';
        const alamat = document.getElementById('ban_alamat').value || '-';
        const lokasi = document.getElementById('ban_lokasi').value || '-';
        const kebutuhan = document.getElementById('ban_kebutuhan').value || '-';
        const pertanyaan = document.getElementById('ban_pertanyaan').value || '-';
        text = `Pesanan Tempel Ban%0AName: ${encodeURIComponent(nama)}%0AAlamat: ${encodeURIComponent(alamat)}%0ALokasi: ${encodeURIComponent(lokasi)}%0AKebutuhan: ${encodeURIComponent(kebutuhan)}%0APertanyaan: ${encodeURIComponent(pertanyaan)}`;
      } else {
        alert('Tipe pesanan tidak dikenal.');
        return;
      }

      // create wa.me link
      const url = `https://wa.me/${ADMIN_WA}?text=${text}`;
      window.open(url, '_blank');
    }

    // OPTIONAL: if user types a URL into antar_tujuan or kirim_penerima and later sets the other point with map, admin can still click URL.
    // The distance/tarif will appear only when both endpoints have coords set via the map (positionStore).

    // For convenience: when user manually pastes an OSM link into an input, try to parse coords (very basic)
    function tryParseOSMUrlToCoords(text){
      if(!text) return null;
      try{
        // match patterns like "#map=18/lat/lon" or "?mlat=...&mlon=..."
        const hashIdx = text.indexOf('#map=');
        if(hashIdx !== -1){
          const after = text.substring(hashIdx + 5); // after '#map='
          const parts = after.split('/');
          if(parts.length >= 3){
            const lat = parseFloat(parts[1]);
            const lon = parseFloat(parts[2]);
            if(!isNaN(lat) && !isNaN(lon)) return {lat, lng: lon};
          }
        }
        // try mlat/mlon
        const mlat = (text.match(/mlat=([-0-9.]+)/) || [])[1];
        const mlon = (text.match(/mlon=([-0-9.]+)/) || [])[1];
        if(mlat && mlon){
          const lat = parseFloat(mlat), lng = parseFloat(mlon);
          if(!isNaN(lat) && !isNaN(lng)) return {lat, lng};
        }
      } catch(e){}
      return null;
    }

    // Watch for manual paste into fields and attempt parse
    document.getElementById('antar_tujuan').addEventListener('change', function(){
      const coords = tryParseOSMUrlToCoords(this.value);
      if(coords){
        positionStore['antar_tujuan'] = coords;
        computeEstimationsForRelevantForms();
      }
    });
    document.getElementById('kirim_penerima').addEventListener('change', function(){
      const coords = tryParseOSMUrlToCoords(this.value);
      if(coords){
        positionStore['kirim_penerima'] = coords;
        computeEstimationsForRelevantForms();
      }
    });

    // Also parse when admin sets jemput/pengirim by using map setter (already stores coords).
    // When modal is hidden we reset tempMarker to avoid confusion
    mapModalEl.addEventListener('hidden.bs.modal', function(){
      // Keep positionStore (we want to keep values)
      if(tempMarker && mapInstance){
        mapInstance.removeLayer(tempMarker);
        tempMarker = null;
      }
      currentTargetInputId = null;
    });

    // Optional helper: if user clicks on an input containing a URL, open it in new tab
    ['antar_jemput','antar_tujuan','kirim_pengirim','kirim_penerima','rumah_lokasi','kebun_lokasi','ban_lokasi'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', function(){
        const v = el.value || '';
        // if it's an OSM url, open
        if(v.startsWith('http')){
          window.open(v, '_blank');
        }
      });
    });

    // END SCRIPT
  </script>
</body>
</html>
