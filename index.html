<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,shrink-to-fit=no">
  <title>Siap Suruh - Layanan Jasa</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Leaflet for maps -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    /* warna dasar: hijau, oranye, putih */
    :root{
      --brand-green: #29a74a;
      --brand-orange: #ff8a00;
      --brand-white: #ffffff;
    }
    body {
      background: linear-gradient(180deg, var(--brand-white) 0%, #f6fff6 100%);
      min-height:100vh;
      padding-bottom:80px; /* for bottom nav */
    }
    .top-banner{
      background: linear-gradient(90deg, var(--brand-green), var(--brand-orange));
      color: white;
      padding: 16px 12px;
      border-radius: 0 0 16px 16px;
      margin-bottom: 12px;
    }
    .card-service{
      border-radius: 12px;
      cursor: pointer;
      transition: transform .12s;
    }
    .card-service:hover{ transform: translateY(-4px); }
    .service-icon{
      width:56px;height:56px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:24px;
      color:white;
    }
    .map-container{ height:320px; width:100%; border-radius:8px; overflow:hidden; }
    .bottom-nav{
      position: fixed; left:0; right:0; bottom:0; height:66px; background: white;
      border-top:1px solid #e6e6e6; display:flex; align-items:center; justify-content:space-around; padding-bottom:6px;
    }
    .bottom-nav .btn { display:flex; flex-direction:column; align-items:center; gap:2px; font-size:12px;}
    .small-note{ font-size:12px; color:#666; }
    /* modal full-screen on mobile */
    @media (max-width:576px){
      .modal-dialog { max-width:100%; margin:0; height:100%; display:flex; align-items:flex-end; }
      .modal-content { border-radius: 16px 16px 0 0; height:92vh; overflow:auto; }
    }
  </style>
</head>
<body>

  <div class="container py-3">
    <!-- Banner -->
    <div class="top-banner d-flex align-items-center justify-content-between">
      <div>
        <h5 class="mb-0">SIAP SURUH, SIAP ANTAR</h5>
        <div class="small-note">Layanan antar, kirim paket & jasa lainnya</div>
      </div>
      <div class="text-end">
        <img src="data:image/svg+xml;utf8,
          <svg xmlns='http://www.w3.org/2000/svg' width='56' height='56'>
            <rect rx='12' width='56' height='56' fill='%23ffffff' opacity='0.18'/>
            <text x='50%' y='58%' dominant-baseline='middle' text-anchor='middle' 
              fill='white' font-size='26' font-family='Arial' font-weight='700'>SS</text>
          </svg>" alt="logo" style="width:56px;height:56px;border-radius:12px;">
      </div>
    </div>

    <!-- Menu Kategori -->
    <div class="row g-3 mb-3">
      <!-- Antar Jemput -->
      <div class="col-6">
        <div class="card card-service p-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalAntar" id="btnAntar">
          <div class="d-flex align-items-center gap-2">
            <div class="service-icon" style="background:var(--brand-green)"><i class="bi bi-bicycle"></i></div>
            <div>
              <div class="fw-bold">Antar Jemput</div>
              <div class="small-note">Order antar-jemput</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Kirim Paket -->
      <div class="col-6">
        <div class="card card-service p-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalKirim" id="btnKirim">
          <div class="d-flex align-items-center gap-2">
            <div class="service-icon" style="background:var(--brand-orange)"><i class="bi bi-box-seam"></i></div>
            <div>
              <div class="fw-bold">Kirim Paket</div>
              <div class="small-note">Kirim barang</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bersihin Rumah -->
      <div class="col-6">
        <div class="card card-service p-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalBersihinRumah">
          <div class="d-flex align-items-center gap-2">
            <div class="service-icon" style="background:#2f9a7d"><i class="bi bi-house-fill"></i></div>
            <div>
              <div class="fw-bold">Bersihin Rumah</div>
              <div class="small-note">Cleaning service</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bersihin Kebun -->
      <div class="col-6">
        <div class="card card-service p-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalBersihinKebun">
          <div class="d-flex align-items-center gap-2">
            <div class="service-icon" style="background:#3fb17f"><i class="bi bi-tree-fill"></i></div>
            <div>
              <div class="fw-bold">Bersihin Kebun</div>
              <div class="small-note">Perawatan kebun</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tempel Ban -->
      <div class="col-6">
        <div class="card card-service p-2 shadow-sm" data-bs-toggle="modal" data-bs-target="#modalTempelBan">
          <div class="d-flex align-items-center gap-2">
            <div class="service-icon" style="background:#57b05a"><i class="bi bi-tools"></i></div>
            <div>
              <div class="fw-bold">Tempel Ban</div>
              <div class="small-note">Tambal ban & layanan</div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Info kecil -->
    <div class="text-center small text-muted mb-4">
      Tarif dasar: <strong>6.000 / KM</strong>. Pembulatan ke ribuan (>=500 dibulatkan ke atas).
    </div>

  </div>

  <!-- MODAL: Antar Jemput -->
  <div class="modal fade" id="modalAntar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Form Antar Jemput</h5>
          <button class="btn btn-sm btn-light" data-bs-dismiss="modal"><i class="bi bi-x"></i></button>
        </div>

        <form id="formAntar">
          <div class="mb-2">
            <label class="form-label">Nama</label>
            <input type="text" class="form-control" id="antar_nama" placeholder="Nama lengkap" required>
          </div>

          <div class="mb-2">
            <label class="form-label">Lokasi Jemputan</label>
            <div class="input-group">
              <input type="text" class="form-control" id="antar_jemput_text" placeholder="Atur lokasi jemput atau klik Set lokasi" readonly>
              <button type="button" class="btn btn-outline-secondary" id="btnSetJemput">Set lokasi</button>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Tujuan Antar</label>
            <div class="input-group">
              <input type="text" class="form-control" id="antar_tujuan_text" placeholder="Atur lokasi tujuan atau ketik alamat" required>
              <button type="button" class="btn btn-outline-secondary" id="btnSetTujuan">Set lokasi</button>
            </div>
            <div class="form-text">Anda bisa mengetik alamat tujuan lalu klik "Cari" atau tekan Set lokasi untuk pilih dari map.</div>
            <div class="input-group mt-2">
              <input type="text" id="tujuan_search" class="form-control" placeholder="Ketik alamat tujuan untuk mencari">
              <button type="button" class="btn btn-primary" id="btnCariTujuan">Cari</button>
            </div>
            <div id="tujuan_results" class="mt-2"></div>
          </div>

          <div class="mb-2">
            <label class="form-label">Estimasi Jarak & Tarif</label>
            <div class="p-2 border rounded" id="antar_estimasi">
              <div>Jarak: <span id="est_jarak">-</span> km</div>
              <div>Tarif kotor: <span id="est_tarif_raw">-</span></div>
              <div>Tarif setelah pembulatan: <strong id="est_tarif">-</strong></div>
            </div>
          </div>

          <div class="d-grid gap-2 mt-3">
            <button type="submit" class="btn btn-success">Kirim Pesanan via WhatsApp</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
          </div>

        </form>
      </div>
    </div>
  </div>

  <!-- MODAL: Kirim Paket (mirip antar) -->
  <div class="modal fade" id="modalKirim" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Form Kirim Paket</h5>
          <button class="btn btn-sm btn-light" data-bs-dismiss="modal"><i class="bi bi-x"></i></button>
        </div>

        <form id="formKirim">
          <div class="mb-2">
            <label class="form-label">Nama</label>
            <input type="text" class="form-control" id="kirim_nama" placeholder="Nama lengkap" required>
          </div>

          <div class="mb-2">
            <label class="form-label">Lokasi Pengambilan</label>
            <div class="input-group">
              <input type="text" class="form-control" id="kirim_pick_text" placeholder="Atur lokasi pengambilan" readonly>
              <button type="button" class="btn btn-outline-secondary" id="btnSetPick">Set lokasi</button>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Lokasi Tujuan</label>
            <div class="input-group">
              <input type="text" class="form-control" id="kirim_drop_text" placeholder="Atur lokasi tujuan atau ketik alamat" required>
              <button type="button" class="btn btn-outline-secondary" id="btnSetDrop">Set lokasi</button>
            </div>
            <div class="input-group mt-2">
              <input type="text" id="kirim_tujuan_search" class="form-control" placeholder="Ketik alamat tujuan untuk mencari">
              <button type="button" class="btn btn-primary" id="btnCariKirimTujuan">Cari</button>
            </div>
            <div id="kirim_tujuan_results" class="mt-2"></div>
          </div>

          <div class="mb-2">
            <label class="form-label">Estimasi Jarak & Tarif</label>
            <div class="p-2 border rounded" id="kirim_estimasi">
              <div>Jarak: <span id="kirim_jarak">-</span> km</div>
              <div>Tarif kotor: <span id="kirim_tarif_raw">-</span></div>
              <div>Tarif setelah pembulatan: <strong id="kirim_tarif">-</strong></div>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Deskripsi Paket (opsional)</label>
            <textarea id="kirim_desc" class="form-control" rows="2" placeholder="Isi detail paket (jenis, berat, catatan)"></textarea>
          </div>

          <div class="d-grid gap-2 mt-3">
            <button type="submit" class="btn btn-primary">Kirim Pesanan via WhatsApp</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL: Bersihin Rumah -->
  <div class="modal fade" id="modalBersihinRumah" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Form Bersihin Rumah</h5>
          <button class="btn btn-sm btn-light" data-bs-dismiss="modal"><i class="bi bi-x"></i></button>
        </div>

        <form id="formBersihinRumah">
          <div class="mb-2"><label class="form-label">Nama</label><input id="br_nama" class="form-control" required></div>
          <div class="mb-2"><label class="form-label">Alamat Lengkap</label><input id="br_alamat" class="form-control" required></div>
          <div class="mb-2">
            <label class="form-label">Set lokasi (izinkan GPS)</label>
            <div class="input-group">
              <input id="br_loc_text" class="form-control" placeholder="Klik set lokasi untuk pakai peta / GPS" readonly>
              <button type="button" class="btn btn-outline-secondary" id="btnBrSetLoc">Set lokasi</button>
            </div>
          </div>
          <div class="mb-2"><label class="form-label">Kebutuhan Jasa</label><input id="br_kebutuhan" class="form-control" placeholder="Contoh: 2 jam bersih, cuci lantai" required></div>
          <div class="mb-2"><label class="form-label">Pertanyaan Estimasi Biaya</label><textarea id="br_pertanyaan" class="form-control" rows="2"></textarea></div>

          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-success" type="submit">Kirim Pesanan via WhatsApp</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL: Bersihin Kebun -->
  <div class="modal fade" id="modalBersihinKebun" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Form Bersihin Kebun</h5>
          <button class="btn btn-sm btn-light" data-bs-dismiss="modal"><i class="bi bi-x"></i></button>
        </div>

        <form id="formBersihinKebun">
          <div class="mb-2"><label class="form-label">Nama</label><input id="bk_nama" class="form-control" required></div>
          <div class="mb-2"><label class="form-label">Alamat Lengkap</label><input id="bk_alamat" class="form-control" required></div>
          <div class="mb-2">
            <label class="form-label">Set lokasi (GPS)</label>
            <div class="input-group">
              <input id="bk_loc_text" class="form-control" readonly>
              <button type="button" class="btn btn-outline-secondary" id="btnBkSetLoc">Set lokasi</button>
            </div>
          </div>
          <div class="mb-2"><label class="form-label">Kebutuhan Jasa</label><input id="bk_kebutuhan" class="form-control" required></div>
          <div class="mb-2"><label class="form-label">Pertanyaan Estimasi Biaya</label><textarea id="bk_pertanyaan" class="form-control" rows="2"></textarea></div>

          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-success" type="submit">Kirim Pesanan via WhatsApp</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL: Tempel Ban -->
  <div class="modal fade" id="modalTempelBan" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content p-3">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h5 class="mb-0">Form Tempel Ban</h5>
          <button class="btn btn-sm btn-light" data-bs-dismiss="modal"><i class="bi bi-x"></i></button>
        </div>

        <form id="formTempelBan">
          <div class="mb-2"><label class="form-label">Nama</label><input id="tb_nama" class="form-control" required></div>
          <div class="mb-2"><label class="form-label">Alamat Lengkap</label><input id="tb_alamat" class="form-control" required></div>
          <div class="mb-2">
            <label class="form-label">Set lokasi (GPS)</label>
            <div class="input-group">
              <input id="tb_loc_text" class="form-control" readonly>
              <button type="button" class="btn btn-outline-secondary" id="btnTbSetLoc">Set lokasi</button>
            </div>
          </div>
          <div class="mb-2"><label class="form-label">Kebutuhan Jasa</label><input id="tb_kebutuhan" class="form-control" placeholder="Contoh: tambal ban + ganti ban" required></div>
          <div class="mb-2"><label class="form-label">Pertanyaan Estimasi Biaya</label><textarea id="tb_pertanyaan" class="form-control" rows="2"></textarea></div>

          <div class="d-grid gap-2 mt-3">
            <button class="btn btn-success" type="submit">Kirim Pesanan via WhatsApp</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- MODAL MAP PICKER (reusable) -->
  <div class="modal fade" id="modalMapPicker" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-fullscreen-sm-down">
      <div class="modal-content">
        <div class="p-2 d-flex align-items-center justify-content-between">
          <h6 id="mapPickerTitle" class="mb-0">Pilih Lokasi</h6>
          <div>
            <button class="btn btn-sm btn-primary" id="saveMapLocation">Simpan</button>
            <button class="btn btn-sm btn-light ms-1" data-bs-dismiss="modal">Batal</button>
          </div>
        </div>
        <div class="p-2">
          <div id="map" class="map-container"></div>
          <div class="mt-2 small text-muted">Seret marker untuk mengubah lokasi. Klik tombol "Simpan" saat lokasi sudah benar.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- bottom nav -->
  <div class="bottom-nav shadow-sm">
    <button class="btn" id="navHome"><i class="bi bi-house-door-fill fs-4" style="color:var(--brand-green)"></i><div>Home</div></button>
    <button class="btn" id="navQuestion"><i class="bi bi-chat-left-text fs-4" style="color:var(--brand-orange)"></i><div>Pertanyaan</div></button>
    <button class="btn" id="navProfile"><i class="bi bi-person-circle fs-4"></i><div>Profil</div></button>
  </div>

  <!-- Dependencies: Leaflet + Bootstrap JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // ADMIN WA number (format internasional, tanpa tanda +)
    const ADMIN_WA = "6281262433533";

    // Helper: Haversine distance (km)
    function haversine(lat1, lon1, lat2, lon2) {
      const toRad = (v) => v * Math.PI / 180;
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Tarif calculation
    function calcFare(distanceKm){
      // tarif per km 6000
      const raw = Math.max(0, Math.round(distanceKm * 1000) / 1000 * 6000); // ensure number
      // But better: raw = distanceKm * 6000
      const rawExact = distanceKm * 6000;
      // pembulatan ke ribuan: <500 -> floor, >=500 -> up
      const rounded = Math.round(rawExact/1000) * 1000;
      return { raw: Math.round(rawExact), rounded };
    }

    // Reusable map picker using Leaflet
    let map, pickerMarker;
    let currentPickerCallback = null;
    let currentPickerTitle = "Pilih Lokasi";

    function initMapPicker(){
      const mapDiv = document.getElementById('map');
      map = L.map(mapDiv).setView([-6.200, 106.816], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      pickerMarker = L.marker(map.getCenter(), { draggable: true }).addTo(map);
    }

    // Open map picker modal and set handler
    function openMapPicker(lat, lng, title, cb){
      currentPickerCallback = cb;
      currentPickerTitle = title || "Pilih Lokasi";
      document.getElementById('mapPickerTitle').innerText = currentPickerTitle;
      const mapModalEl = document.getElementById('modalMapPicker');
      const mapModal = new bootstrap.Modal(mapModalEl);
      mapModal.show();

      // set marker and view
      if (!map) {
        setTimeout(() => {
          initMapPicker();
          map.setView([lat || -6.200, lng || 106.816], lat && lng ? 15 : 13);
          pickerMarker.setLatLng([lat || -6.200, lng || 106.816]);
          map.invalidateSize();
        }, 250);
      } else {
        map.setView([lat || -6.200, lng || 106.816], lat && lng ? 15 : 13);
        pickerMarker.setLatLng([lat || -6.200, lng || 106.816]);
        map.invalidateSize();
      }
    }

    // Reverse geocode (Nominatim)
    async function reverseGeocode(lat, lon){
      try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=jsonv2`);
        if (!resp.ok) return null;
        const data = await resp.json();
        return data.display_name || null;
      } catch (e) { return null; }
    }

    // Geocode search (Nominatim)
    async function geocodeQuery(q){
      try {
        const resp = await fetch(`https://nominatim.openstreetmap.org/search?format=jsonv2&q=${encodeURIComponent(q)}&limit=5`);
        if (!resp.ok) return [];
        const data = await resp.json();
        return data; // array
      } catch (e) { return []; }
    }

    // On save map location
    document.getElementById('saveMapLocation').addEventListener('click', async ()=>{
      const latlng = pickerMarker.getLatLng();
      const address = await reverseGeocode(latlng.lat, latlng.lng);
      // call callback
      if (typeof currentPickerCallback === "function") currentPickerCallback({
        lat: latlng.lat, lng: latlng.lng, address: address || `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`
      });
      // hide modal
      const mapModalEl = document.getElementById('modalMapPicker');
      bootstrap.Modal.getInstance(mapModalEl).hide();
    });

    // When modal map shown, invalidate size
    document.getElementById('modalMapPicker').addEventListener('shown.bs.modal', function(){
      setTimeout(()=> map.invalidateSize(), 200);
    });

    // Hook up map picker buttons for each form
    // ANTAR
    let antarPick = null, antarDrop = null;
    document.getElementById('btnSetJemput').addEventListener('click', ()=>{
      openMapPicker(antarPick?.lat, antarPick?.lng, "Set Lokasi Jemput", (loc)=>{
        antarPick = loc;
        document.getElementById('antar_jemput_text').value = loc.address;
        updateAntarEstimasi();
      });
    });
    document.getElementById('btnSetTujuan').addEventListener('click', ()=>{
      openMapPicker(antarDrop?.lat, antarDrop?.lng, "Set Lokasi Tujuan", (loc)=>{
        antarDrop = loc;
        document.getElementById('antar_tujuan_text').value = loc.address;
        updateAntarEstimasi();
      });
    });
    document.getElementById('btnCariTujuan').addEventListener('click', async ()=>{
      const q = document.getElementById('tujuan_search').value.trim();
      const resultsDiv = document.getElementById('tujuan_results');
      resultsDiv.innerHTML = 'Mencari...';
      const res = await geocodeQuery(q);
      if (!res || res.length===0) { resultsDiv.innerHTML = '<div class="text-danger small">Hasil tidak ditemukan</div>'; return; }
      resultsDiv.innerHTML = '';
      res.forEach(r =>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-outline-secondary me-2 mb-2';
        btn.innerText = r.display_name;
        btn.addEventListener('click', ()=>{
          antarDrop = { lat: parseFloat(r.lat), lng: parseFloat(r.lon), address: r.display_name };
          document.getElementById('antar_tujuan_text').value = r.display_name;
          resultsDiv.innerHTML = '<div class="small text-success">Lokasi dipilih dari hasil pencarian.</div>';
          updateAntarEstimasi();
        });
        resultsDiv.appendChild(btn);
      });
    });

    // KIRIM
    let kirimPick = null, kirimDrop = null;
    document.getElementById('btnSetPick').addEventListener('click', ()=>{
      openMapPicker(kirimPick?.lat, kirimPick?.lng, "Set Lokasi Pengambilan", (loc)=>{
        kirimPick = loc;
        document.getElementById('kirim_pick_text').value = loc.address;
        updateKirimEstimasi();
      });
    });
    document.getElementById('btnSetDrop').addEventListener('click', ()=>{
      openMapPicker(kirimDrop?.lat, kirimDrop?.lng, "Set Lokasi Tujuan", (loc)=>{
        kirimDrop = loc;
        document.getElementById('kirim_drop_text').value = loc.address;
        updateKirimEstimasi();
      });
    });
    document.getElementById('btnCariKirimTujuan').addEventListener('click', async ()=>{
      const q = document.getElementById('kirim_tujuan_search').value.trim();
      const resultsDiv = document.getElementById('kirim_tujuan_results');
      resultsDiv.innerHTML = 'Mencari...';
      const res = await geocodeQuery(q);
      if (!res || res.length===0) { resultsDiv.innerHTML = '<div class="text-danger small">Hasil tidak ditemukan</div>'; return; }
      resultsDiv.innerHTML = '';
      res.forEach(r =>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn btn-sm btn-outline-secondary me-2 mb-2';
        btn.innerText = r.display_name;
        btn.addEventListener('click', ()=>{
          kirimDrop = { lat: parseFloat(r.lat), lng: parseFloat(r.lon), address: r.display_name };
          document.getElementById('kirim_drop_text').value = r.display_name;
          resultsDiv.innerHTML = '<div class="small text-success">Lokasi dipilih dari hasil pencarian.</div>';
          updateKirimEstimasi();
        });
        resultsDiv.appendChild(btn);
      });
    });

    // Update estimasi antar
    function updateAntarEstimasi(){
      const elJarak = document.getElementById('est_jarak');
      const elRaw = document.getElementById('est_tarif_raw');
      const elRounded = document.getElementById('est_tarif');
      if (antarPick && antarDrop){
        const km = haversine(antarPick.lat, antarPick.lng, antarDrop.lat, antarDrop.lng);
        const kmRounded = (Math.round(km*100)/100).toFixed(2);
        const fares = calcFare(km);
        elJarak.innerText = kmRounded;
        elRaw.innerText = 'Rp ' + numberWithCommas(fares.raw);
        elRounded.innerText = 'Rp ' + numberWithCommas(fares.rounded);
      } else {
        elJarak.innerText = '-';
        elRaw.innerText = '-';
        elRounded.innerText = '-';
      }
    }

    function updateKirimEstimasi(){
      const elJarak = document.getElementById('kirim_jarak');
      const elRaw = document.getElementById('kirim_tarif_raw');
      const elRounded = document.getElementById('kirim_tarif');
      if (kirimPick && kirimDrop){
        const km = haversine(kirimPick.lat, kirimPick.lng, kirimDrop.lat, kirimDrop.lng);
        const kmRounded = (Math.round(km*100)/100).toFixed(2);
        const fares = calcFare(km);
        elJarak.innerText = kmRounded;
        elRaw.innerText = 'Rp ' + numberWithCommas(fares.raw);
        elRounded.innerText = 'Rp ' + numberWithCommas(fares.rounded);
      } else {
        elJarak.innerText = '-';
        elRaw.innerText = '-';
        elRounded.innerText = '-';
      }
    }

    function numberWithCommas(x){
      return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    // Form submit handlers to build WA message
    document.getElementById('formAntar').addEventListener('submit', function(e){
      e.preventDefault();
      const name = document.getElementById('antar_nama').value || '-';
      if (!antarPick || !antarDrop){
        alert('Mohon set lokasi jemput dan tujuan terlebih dahulu.');
        return;
      }
      const km = haversine(antarPick.lat, antarPick.lng, antarDrop.lat, antarDrop.lng);
      const fares = calcFare(km);
      const message = 
        `*Order Antar Jemput*%0A` +
        `Nama: ${encodeURIComponent(name)}%0A` +
        `Jemput: ${encodeURIComponent(antarPick.address)} (%20lat:${antarPick.lat.toFixed(6)},lng:${antarPick.lng.toFixed(6)}%20)%0A` +
        `Tujuan: ${encodeURIComponent(antarDrop.address)} (%20lat:${antarDrop.lat.toFixed(6)},lng:${antarDrop.lng.toFixed(6)}%20)%0A` +
        `Jarak: ${km.toFixed(2)} km%0A` +
        `Tarif (kotor): Rp ${numberWithCommas(fares.raw)}%0A` +
        `Tarif (dibulatkan): Rp ${numberWithCommas(fares.rounded)}%0A` +
        `Catatan: -`;
      // open wa
      window.open(`https://wa.me/${ADMIN_WA}?text=${message}`, "_blank");
    });

    document.getElementById('formKirim').addEventListener('submit', function(e){
      e.preventDefault();
      const name = document.getElementById('kirim_nama').value || '-';
      const desc = document.getElementById('kirim_desc').value || '-';
      if (!kirimPick || !kirimDrop){
        alert('Mohon set lokasi pengambilan dan tujuan terlebih dahulu.');
        return;
      }
      const km = haversine(kirimPick.lat, kirimPick.lng, kirimDrop.lat, kirimDrop.lng);
      const fares = calcFare(km);
      const message =
        `*Order Kirim Paket*%0A` +
        `Nama: ${encodeURIComponent(name)}%0A` +
        `Pengambilan: ${encodeURIComponent(kirimPick.address)} (%20lat:${kirimPick.lat.toFixed(6)},lng:${kirimPick.lng.toFixed(6)}%20)%0A` +
        `Tujuan: ${encodeURIComponent(kirimDrop.address)} (%20lat:${kirimDrop.lat.toFixed(6)},lng:${kirimDrop.lng.toFixed(6)}%20)%0A` +
        `Jarak: ${km.toFixed(2)} km%0A` +
        `Tarif (kotor): Rp ${numberWithCommas(fares.raw)}%0A` +
        `Tarif (dibulatkan): Rp ${numberWithCommas(fares.rounded)}%0A` +
        `Deskripsi Paket: ${encodeURIComponent(desc)}`;
      window.open(`https://wa.me/${ADMIN_WA}?text=${message}`, "_blank");
    });

    // Bersihin Rumah submit
    document.getElementById('formBersihinRumah').addEventListener('submit', function(e){
      e.preventDefault();
      const name = document.getElementById('br_nama').value || '-';
      const alamat = document.getElementById('br_alamat').value || '-';
      const kebutuhan = document.getElementById('br_kebutuhan').value || '-';
      const pertanyaan = document.getElementById('br_pertanyaan').value || '-';
      const locText = document.getElementById('br_loc_text').value || '-';
      const message =
        `*Order Bersihin Rumah*%0A` +
        `Nama: ${encodeURIComponent(name)}%0A` +
        `Alamat: ${encodeURIComponent(alamat)}%0A` +
        `Lokasi: ${encodeURIComponent(locText)}%0A` +
        `Kebutuhan: ${encodeURIComponent(kebutuhan)}%0A` +
        `Pertanyaan: ${encodeURIComponent(pertanyaan)}`;
      window.open(`https://wa.me/${ADMIN_WA}?text=${message}`, "_blank");
    });

    // Bersihin Kebun submit
    document.getElementById('formBersihinKebun').addEventListener('submit', function(e){
      e.preventDefault();
      const name = document.getElementById('bk_nama').value || '-';
      const alamat = document.getElementById('bk_alamat').value || '-';
      const kebutuhan = document.getElementById('bk_kebutuhan').value || '-';
      const pertanyaan = document.getElementById('bk_pertanyaan').value || '-';
      const locText = document.getElementById('bk_loc_text').value || '-';
      const message =
        `*Order Bersihin Kebun*%0A` +
        `Nama: ${encodeURIComponent(name)}%0A` +
        `Alamat: ${encodeURIComponent(alamat)}%0A` +
        `Lokasi: ${encodeURIComponent(locText)}%0A` +
        `Kebutuhan: ${encodeURIComponent(kebutuhan)}%0A` +
        `Pertanyaan: ${encodeURIComponent(pertanyaan)}`;
      window.open(`https://wa.me/${ADMIN_WA}?text=${message}`, "_blank");
    });

    // Tempel Ban submit
    document.getElementById('formTempelBan').addEventListener('submit', function(e){
      e.preventDefault();
      const name = document.getElementById('tb_nama').value || '-';
      const alamat = document.getElementById('tb_alamat').value || '-';
      const kebutuhan = document.getElementById('tb_kebutuhan').value || '-';
      const pertanyaan = document.getElementById('tb_pertanyaan').value || '-';
      const locText = document.getElementById('tb_loc_text').value || '-';
      const message =
        `*Order Tempel Ban*%0A` +
        `Nama: ${encodeURIComponent(name)}%0A` +
        `Alamat: ${encodeURIComponent(alamat)}%0A` +
        `Lokasi: ${encodeURIComponent(locText)}%0A` +
        `Kebutuhan: ${encodeURIComponent(kebutuhan)}%0A` +
        `Pertanyaan: ${encodeURIComponent(pertanyaan)}`;
      window.open(`https://wa.me/${ADMIN_WA}?text=${message}`, "_blank");
    });

    // GPS-based set location for services that ask for GPS permission
    async function setLocationByGPS(targetInputId){
      if (!navigator.geolocation) { alert('Browser tidak mendukung geolocation.'); return; }
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude, lon = pos.coords.longitude;
        const address = await reverseGeocode(lat, lon);
        document.getElementById(targetInputId).value = address || `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
      }, (err)=>{
        alert('Gagal mengambil lokasi. Pastikan izinkan GPS di browser/perangkat Anda.');
      }, { enableHighAccuracy: true, timeout: 10000 });
    }

    // Connect GPS buttons to inputs
    document.getElementById('btnBrSetLoc').addEventListener('click', ()=>{
      // allow either GPS or map
      if (confirm('Gunakan lokasi GPS sekarang? (OK = GPS, Cancel = pilih di peta)')) {
        setLocationByGPS('br_loc_text');
      } else {
        openMapPicker(null, null, "Pilih Lokasi Bersihin Rumah", async (loc)=>{
          document.getElementById('br_loc_text').value = loc.address;
        });
      }
    });
    document.getElementById('btnBkSetLoc').addEventListener('click', ()=>{
      if (confirm('Gunakan lokasi GPS sekarang? (OK = GPS, Cancel = pilih di peta)')) {
        setLocationByGPS('bk_loc_text');
      } else {
        openMapPicker(null,null,"Pilih Lokasi Bersihin Kebun", async (loc)=>{
          document.getElementById('bk_loc_text').value = loc.address;
        });
      }
    });
    document.getElementById('btnTbSetLoc').addEventListener('click', ()=>{
      if (confirm('Gunakan lokasi GPS sekarang? (OK = GPS, Cancel = pilih di peta)')) {
        setLocationByGPS('tb_loc_text');
      } else {
        openMapPicker(null,null,"Pilih Lokasi Tempel Ban", async (loc)=>{
          document.getElementById('tb_loc_text').value = loc.address;
        });
      }
    });

    // Simple navigation buttons (placeholder)
    document.getElementById('navHome').addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
    document.getElementById('navQuestion').addEventListener('click', ()=> {
      const text = encodeURIComponent("Halo Admin, saya mau tanya layanan...");
      window.open(`https://wa.me/${ADMIN_WA}?text=${text}`, "_blank");
    });
    document.getElementById('navProfile').addEventListener('click', ()=> alert('Profil belum dibuat.'));

    // Initialize map picker once document loaded
    document.addEventListener('DOMContentLoaded', ()=>{
      // Pre-initialize small map after a delay to avoid rendering issues
      setTimeout(()=> {
        initMapPicker();
      }, 300);

      // Ensure when any modal opens we fix map size
      const modalIds = ['modalAntar','modalKirim','modalMapPicker'];
      modalIds.forEach(id=>{
        const el = document.getElementById(id);
        el && el.addEventListener('shown.bs.modal', ()=> { if (map) map.invalidateSize(); });
      });
    });

    // Ensure map marker follows map click when user clicks on the map picker
    // (Leaflet added, we add click handler)
    (function waitForMap(){
      if (window.map && window.pickerMarker){
        map.on('click', function(e){
          pickerMarker.setLatLng(e.latlng);
        });
      } else {
        setTimeout(waitForMap, 300);
      }
    })();

    // Small UX: when choosing location from search result, maybe zoom map
    // Already handled by opening picker and setting center when open

    // Note: Nominatim has usage policy -> avoid heavy/prod use without proper setup.
  </script>

</body>
</html>
