<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Siap Suruh - Siap Antar</title>

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

  <!-- FontAwesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --primary-green:#2ea44f;
      --accent-orange:#ff8a33;
      --bg-white:#ffffff;
    }
    body{
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: var(--bg-white);
      padding-bottom: 72px; /* space for bottom nav */
    }
    .top-banner{
      background: linear-gradient(90deg,var(--primary-green),var(--accent-orange));
      color: #fff;
      padding: 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .top-banner h1{font-size:18px;margin:0}
    .card-cat { border-radius:12px; box-shadow: 0 6px 18px rgba(0,0,0,.06); cursor:pointer; }
    .cat-icon{font-size:28px}
    .bottom-nav{
      position:fixed; left:0; right:0; bottom:0; background:#fff; border-top:1px solid #e9ecef; z-index:1050;
      display:flex; justify-content:space-around; padding:8px 0;
    }
    #mapModalMap, #mapPickup, #mapDrop { height: 380px; }
    .small-muted{font-size:13px;color:#6c757d}
    @media (max-width:576px){
      #mapModalMap, #mapPickup, #mapDrop { height: 260px; }
      .top-banner h1{font-size:16px}
    }
  </style>
</head>
<body>

  <!-- Banner -->
  <header class="top-banner">
    <div>
      <h1>SIAP SURUH</h1>
      <div class="small-muted">SIAP ANTAR</div>
    </div>
    <div>
      <button class="btn btn-sm btn-light" aria-hidden="true">App</button>
    </div>
  </header>

  <main class="container py-3">
    <!-- Category Cards -->
    <div class="row g-3">
      <div class="col-6">
        <div class="p-3 card-cat text-center" data-bs-toggle="modal" data-bs-target="#modalAntar">
          <div class="cat-icon text-success"><i class="fa-solid fa-motorcycle"></i></div>
          <div class="mt-2 fw-bold">Jasa Antar</div>
        </div>
      </div>
      <div class="col-6">
        <div class="p-3 card-cat text-center" data-bs-toggle="modal" data-bs-target="#modalKirim">
          <div class="cat-icon text-warning"><i class="fa-solid fa-box"></i></div>
          <div class="mt-2 fw-bold">Kirim Paket</div>
        </div>
      </div>

      <div class="col-6">
        <div class="p-3 card-cat text-center" data-bs-toggle="modal" data-bs-target="#modalService" data-service="Bersihin Rumah">
          <div class="cat-icon text-primary"><i class="fa-solid fa-house"></i></div>
          <div class="mt-2 fw-bold">Bersihin Rumah</div>
        </div>
      </div>

      <div class="col-6">
        <div class="p-3 card-cat text-center" data-bs-toggle="modal" data-bs-target="#modalService" data-service="Bersihin Kebun">
          <div class="cat-icon text-success"><i class="fa-solid fa-tree"></i></div>
          <div class="mt-2 fw-bold">Bersihin Kebun</div>
        </div>
      </div>

      <div class="col-12">
        <div class="p-3 card-cat text-center" data-bs-toggle="modal" data-bs-target="#modalService" data-service="Tempel Ban">
          <div class="cat-icon text-dark"><i class="fa-solid fa-tools"></i></div>
          <div class="mt-2 fw-bold">Tempel Ban</div>
        </div>
      </div>
    </div>

    <hr class="my-4">
    <p class="small-muted">Pilih layanan di atas. Untuk layanan Antar & Kirim Paket: Anda dapat set titik jemput & tujuan melalui GPS / peta. Form akan dikirim via WhatsApp ke admin.</p>
  </main>

  <!-- Modal: Antar Jemput -->
  <div class="modal fade" id="modalAntar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-motorcycle text-success me-2"></i> Antar Jemput</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formAntar">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input type="text" id="antarNama" class="form-control" placeholder="Nama pemesan" required>
            </div>

            <div class="row">
              <div class="col-12 col-md-6 mb-2">
                <label class="form-label">Lokasi Jemputan</label>
                <div class="input-group">
                  <input type="text" id="pickupAddress" class="form-control" placeholder="Set lokasi (lat,lon) atau ketik" required>
                  <button type="button" class="btn btn-outline-secondary" id="btnSetPickup">Set lokasi</button>
                </div>
                <div class="small-muted mt-1">Bisa klik Set lokasi untuk memilih di peta / gunakan GPS</div>
              </div>

              <div class="col-12 col-md-6 mb-2">
                <label class="form-label">Tujuan Antar</label>
                <div class="input-group">
                  <input type="text" id="dropAddress" class="form-control" placeholder="Set lokasi (lat,lon) atau ketik alamat" required>
                  <button type="button" class="btn btn-outline-secondary" id="btnSetDrop">Set lokasi</button>
                </div>
                <div class="small-muted mt-1">Anda dapat mengetik alamat atau set lokasi pada peta</div>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label">Estimasi Jarak & Tarif</label>
              <div class="p-3 border rounded" id="estBox">-</div>
            </div>

            <div class="d-grid">
              <button type="button" id="sendAntarBtn" class="btn" style="background:var(--primary-green);color:#fff">Kirim Pesanan via WhatsApp</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Kirim Paket -->
  <div class="modal fade" id="modalKirim" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-box text-warning me-2"></i> Kirim Paket</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formKirim">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input type="text" id="kirimNama" class="form-control" required>
            </div>

            <div class="row">
              <div class="col-12 col-md-6 mb-2">
                <label class="form-label">Lokasi Pengambilan</label>
                <div class="input-group">
                  <input type="text" id="kPickupAddress" class="form-control" placeholder="Set lokasi (lat,lon) atau ketik" required>
                  <button type="button" class="btn btn-outline-secondary" id="btnSetKPickup">Set lokasi</button>
                </div>
              </div>

              <div class="col-12 col-md-6 mb-2">
                <label class="form-label">Lokasi Tujuan</label>
                <div class="input-group">
                  <input type="text" id="kDropAddress" class="form-control" placeholder="Set lokasi (lat,lon) atau ketik" required>
                  <button type="button" class="btn btn-outline-secondary" id="btnSetKDrop">Set lokasi</button>
                </div>
              </div>
            </div>

            <div class="mb-2">
              <label class="form-label">Estimasi Jarak & Tarif</label>
              <div class="p-3 border rounded" id="estBoxK">-</div>
            </div>

            <div class="d-grid">
              <button type="button" id="sendKirimBtn" class="btn" style="background:var(--accent-orange);color:#fff">Kirim Pesanan via WhatsApp</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Service (Bersihin rumah/kebun/tempel ban) -->
  <div class="modal fade" id="modalService" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen-sm-down modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-solid fa-house me-2"></i> Form Pesanan Jasa</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <form id="formService">
            <input type="hidden" id="svcType" value="">
            <div class="mb-2">
              <label class="form-label">Nama</label>
              <input type="text" id="svcNama" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Alamat Lengkap</label>
              <input type="text" id="svcAlamat" class="form-control" required>
            </div>
            <div class="mb-2">
              <label class="form-label">Set Lokasi</label>
              <div class="input-group">
                <input type="text" id="svcAddress" class="form-control" placeholder="Set lokasi (lat,lon) atau ketik" required>
                <button type="button" class="btn btn-outline-secondary" id="btnSetSvc">Set lokasi</button>
              </div>
            </div>
            <div class="mb-2">
              <label class="form-label">Kebutuhan Jasa</label>
              <textarea id="svcNeeds" class="form-control" rows="2"></textarea>
            </div>
            <div class="mb-2">
              <label class="form-label">Pertanyaan Estimasi Biaya</label>
              <textarea id="svcQuestion" class="form-control" rows="2"></textarea>
            </div>
            <div class="d-grid">
              <button type="button" id="sendSvcBtn" class="btn btn-success">Kirim Pesanan via WhatsApp</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Map (fullscreen) -->
  <div class="modal fade" id="modalMap" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-fullscreen">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Pilih Lokasi di Peta</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-0">
          <div id="mapModalMap" style="width:100%;height:100%;"></div>
        </div>
        <div class="modal-footer d-flex flex-column align-items-stretch">
          <div class="w-100 mb-2">
            <div class="input-group">
              <input type="search" id="mapSearch" class="form-control" placeholder="Cari alamat (ketik & Enter)">
              <button type="button" id="btnUseGPS" class="btn btn-outline-secondary">Gunakan GPS Saya</button>
            </div>
          </div>
          <div class="w-100 d-flex justify-content-end gap-2">
            <button type="button" id="btnSaveMap" class="btn btn-primary">Simpan Lokasi</button>
            <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Batal</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bottom Nav -->
  <nav class="bottom-nav">
    <div class="text-center">
      <div><i class="fa-solid fa-home fa-lg"></i></div>
      <div class="small-muted">Home</div>
    </div>
    <div class="text-center" data-bs-toggle="modal" data-bs-target="#modalService">
      <div><i class="fa-regular fa-message fa-lg"></i></div>
      <div class="small-muted">Pertanyaan</div>
    </div>
    <div class="text-center">
      <div><i class="fa-solid fa-user fa-lg"></i></div>
      <div class="small-muted">Profil</div>
    </div>
  </nav>

  <!-- Scripts: Bootstrap, Leaflet -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    /* ---------- Konfigurasi ---------- */
    const ADMIN_WA = '6281262433533'; // no plus, no spaces
    const RATE_PER_KM = 6000; // Rp per km

    /* ---------- Helpers ---------- */
    function toRad(d){ return d * Math.PI / 180; }
    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371; // km
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function roundToThousandRule(amount){
      // aturan: bila sisa < 500 => dibulatkan ke bawah ke 1000 terdekat
      // bila sisa >= 500 => dibulatkan ke atas ke 1000 terdekat
      return Math.round(amount / 1000) * 1000;
      // (Math.round mengikuti aturan contoh 4450->4000, 4560->5000)
    }

    /* ---------- Map State ---------- */
    let mapInstance = null;
    let activeMarker = null;
    let currentTargetInput = null; // input DOM element yang akan menerima lat,lon
    let tempLatLng = null;

    // Initialize map when modal shown
    const modalMapEl = document.getElementById('modalMap');
    modalMapEl.addEventListener('shown.bs.modal', () => {
      setTimeout(() => {
        if(!mapInstance){
          mapInstance = L.map('mapModalMap').setView([-6.200000,106.816666], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors', maxZoom: 19
          }).addTo(mapInstance);

          mapInstance.on('click', function(e){
            placeMarker(e.latlng);
          });
        }
        mapInstance.invalidateSize();
      }, 250);
    });

    function placeMarker(latlng){
      if(activeMarker) mapInstance.removeLayer(activeMarker);
      activeMarker = L.marker(latlng, { draggable:true }).addTo(mapInstance);
      activeMarker.on('dragend', function(){ tempLatLng = activeMarker.getLatLng(); });
      tempLatLng = latlng;
    }

    document.getElementById('btnUseGPS').addEventListener('click', function(){
      if(!navigator.geolocation){
        alert('Geolocation tidak tersedia pada perangkat ini.');
        return;
      }
      navigator.geolocation.getCurrentPosition((pos)=>{
        const latlng = [pos.coords.latitude, pos.coords.longitude];
        mapInstance.setView(latlng, 16);
        placeMarker(latlng);
      }, (err)=>{
        alert('Gagal mendapatkan lokasi: ' + err.message);
      });
    });

    // Search with Nominatim on Enter
    document.getElementById('mapSearch').addEventListener('keydown', async function(e){
      if(e.key !== 'Enter') return;
      e.preventDefault();
      const q = this.value.trim();
      if(!q) return;
      try{
        const res = await fetch('https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(q));
        const data = await res.json();
        if(data && data.length){
          const it = data[0];
          const lat = parseFloat(it.lat), lon = parseFloat(it.lon);
          mapInstance.setView([lat,lon], 16);
          placeMarker([lat,lon]);
        } else {
          alert('Lokasi tidak ditemukan.');
        }
      } catch(e){
        alert('Gagal mencari lokasi.');
      }
    });

    // Save map location to the target input
    document.getElementById('btnSaveMap').addEventListener('click', function(){
      if(!tempLatLng || !currentTargetInput){
        alert('Tandai lokasi terlebih dahulu.');
        return;
      }
      const lat = tempLatLng.lat.toFixed(6);
      const lon = tempLatLng.lng.toFixed(6);
      currentTargetInput.value = lat + ',' + lon;
      // Reset state
      tempLatLng = null;
      currentTargetInput = null;
      const bs = bootstrap.Modal.getInstance(modalMapEl);
      bs.hide();
      document.getElementById('mapSearch').value = '';
    });

    // Open map modal to set a specific input
    function openMapForInput(inputEl){
      currentTargetInput = inputEl;
      const bs = new bootstrap.Modal(modalMapEl);
      bs.show();
      // If input already has lat,lon, center map
      const val = inputEl.value.trim();
      const p = parseLatLon(val);
      if(p && mapInstance){
        mapInstance.setView([p.lat, p.lon], 16);
        placeMarker([p.lat, p.lon]);
      }
    }

    // Parse lat,lon from "lat,lon" string
    function parseLatLon(str){
      if(!str) return null;
      const parts = str.split(',').map(s=>s.trim());
      if(parts.length < 2) return null;
      const lat = parseFloat(parts[0]), lon = parseFloat(parts[1]);
      if(isNaN(lat) || isNaN(lon)) return null;
      return {lat, lon};
    }

    // Hook set location buttons
    document.getElementById('btnSetPickup').addEventListener('click', ()=> openMapForInput(document.getElementById('pickupAddress')));
    document.getElementById('btnSetDrop').addEventListener('click', ()=> openMapForInput(document.getElementById('dropAddress')));
    document.getElementById('btnSetKPickup').addEventListener('click', ()=> openMapForInput(document.getElementById('kPickupAddress')));
    document.getElementById('btnSetKDrop').addEventListener('click', ()=> openMapForInput(document.getElementById('kDropAddress')));
    document.getElementById('btnSetSvc').addEventListener('click', ()=> openMapForInput(document.getElementById('svcAddress')));

    /* ---------- Estimation Logic ---------- */
    function updateEstimateFor(pickInputEl, dropInputEl, targetBoxEl){
      const p = parseLatLon(pickInputEl.value.trim());
      const d = parseLatLon(dropInputEl.value.trim());
      if(!p || !d){
        targetBoxEl.innerText = 'Tandai lokasi jemput & tujuan pada peta atau masukkan koordinat (lat,lon).';
        return null;
      }
      const km = haversine(p.lat, p.lon, d.lat, d.lon);
      const rawTarif = km * RATE_PER_KM;
      const rounded = roundToThousandRule(rawTarif);
      // Display
      targetBoxEl.innerHTML = '<strong>' + km.toFixed(2) + ' km</strong> — Tarif: Rp ' + rawTarif.toLocaleString('id-ID') + ' → <strong>Rp ' + rounded.toLocaleString('id-ID') + '</strong>';
      return {km, rawTarif, rounded};
    }

    // Update on change events
    ['pickupAddress','dropAddress'].forEach(id=>{
      document.getElementById(id).addEventListener('change', ()=> updateEstimateFor(document.getElementById('pickupAddress'), document.getElementById('dropAddress'), document.getElementById('estBox')));
    });
    ['kPickupAddress','kDropAddress'].forEach(id=>{
      document.getElementById(id).addEventListener('change', ()=> updateEstimateFor(document.getElementById('kPickupAddress'), document.getElementById('kDropAddress'), document.getElementById('estBoxK')));
    });

    // Clear estimate when modal closes
    document.getElementById('modalAntar').addEventListener('hidden.bs.modal', ()=> { document.getElementById('estBox').innerText = '-'; });
    document.getElementById('modalKirim').addEventListener('hidden.bs.modal', ()=> { document.getElementById('estBoxK').innerText = '-'; });

    /* ---------- WhatsApp Message Builders ---------- */
    function sendWhatsApp(text){
      const url = 'https://wa.me/' + ADMIN_WA + '?text=' + encodeURIComponent(text);
      window.open(url, '_blank');
    }

    // Antar send
    document.getElementById('sendAntarBtn').addEventListener('click', function(){
      const name = document.getElementById('antarNama').value.trim();
      const p = document.getElementById('pickupAddress').value.trim();
      const d = document.getElementById('dropAddress').value.trim();
      if(!name || !p || !d){ alert('Lengkapi Nama, Lokasi Jemput dan Tujuan Antar.'); return; }
      const est = updateEstimateFor(document.getElementById('pickupAddress'), document.getElementById('dropAddress'), document.getElementById('estBox')) || {};
      const msg = `Pesanan Antar Jemput%0ANama: ${name}%0ALokasi Jemput: ${p}%0ATujuan Antar: ${d}%0AJarak: ${est.km ? est.km.toFixed(2)+' km' : '-'}%0ATarif: Rp ${est.rounded ? est.rounded.toLocaleString('id-ID') : '-'}`;
      sendWhatsApp(decodeURIComponent(msg)); // decodeURIComponent to avoid double-encoding in wa.me
    });

    // Kirim paket send
    document.getElementById('sendKirimBtn').addEventListener('click', function(){
      const name = document.getElementById('kirimNama').value.trim();
      const p = document.getElementById('kPickupAddress').value.trim();
      const d = document.getElementById('kDropAddress').value.trim();
      if(!name || !p || !d){ alert('Lengkapi Nama, Lokasi Pengambilan dan Lokasi Tujuan.'); return; }
      const est = updateEstimateFor(document.getElementById('kPickupAddress'), document.getElementById('kDropAddress'), document.getElementById('estBoxK')) || {};
      const msg = `Pesanan Kirim Paket%0ANama: ${name}%0ALokasi Pengambilan: ${p}%0ALokasi Tujuan: ${d}%0AJarak: ${est.km ? est.km.toFixed(2)+' km' : '-'}%0ATarif: Rp ${est.rounded ? est.rounded.toLocaleString('id-ID') : '-'}`;
      sendWhatsApp(decodeURIComponent(msg));
    });

    // Service send (Bersihin rumah/kebun/tempel ban)
    document.getElementById('sendSvcBtn').addEventListener('click', function(){
      const type = document.getElementById('svcType').value || 'Layanan Jasa';
      const name = document.getElementById('svcNama').value.trim();
      const alamat = document.getElementById('svcAlamat').value.trim();
      const loc = document.getElementById('svcAddress').value.trim();
      const needs = document.getElementById('svcNeeds').value.trim();
      const q = document.getElementById('svcQuestion').value.trim();
      if(!name || !alamat || !loc){ alert('Lengkapi Nama, Alamat dan Set Lokasi.'); return; }
      const msg = `Pesanan ${type}%0ANama: ${name}%0AAlamat: ${alamat}%0ALokasi: ${loc}%0AKebutuhan: ${needs}%0APertanyaan/Estimasi: ${q}`;
      sendWhatsApp(decodeURIComponent(msg));
    });

    /* ---------- Service modal: set type when opened by different card ---------- */
    const modalServiceEl = document.getElementById('modalService');
    modalServiceEl.addEventListener('show.bs.modal', function(event){
      const trigger = event.relatedTarget;
      let svc = 'Layanan Jasa';
      if(trigger && trigger.dataset && trigger.dataset.service) svc = trigger.dataset.service;
      document.getElementById('svcType').value = svc;
      // Update modal title
      modalServiceEl.querySelector('.modal-title').textContent = svc;
    });

    /* ---------- Utility: decodeURIComponent wrapper for nicer messages ---------- */
    // Note: earlier we used decodeURIComponent(msg) because we pre-encoded fields with %0A in msg.
    // To ensure consistent encoding, build messages without %0A and allow sendWhatsApp function to encode.
    // (Above code used decodeURIComponent to fit current small approach.)
  </script>
</body>
</html>
