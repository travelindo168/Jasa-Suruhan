<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Siap Suruh • Siap Antar</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --green:#2fa84f;
      --orange:#ff8a2b;
      --white:#ffffff;
    }
    body { background: linear-gradient(180deg, #f7fff6 0%, #ffffff 100%); }
    .app-header {
      background: linear-gradient(90deg,var(--green), var(--orange));
      color: white;
      padding: 16px;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
    }
    .category-btn {
      border-radius: 12px;
      padding: 12px;
      text-align:center;
      background:#fff;
      box-shadow: 0 2px 6px rgba(0,0,0,.08);
      color:#222;
    }
    .category-icon {
      width:44px; height:44px; display:inline-flex; align-items:center; justify-content:center;
      border-radius:10px; margin-bottom:6px;
    }
    .cat-row { gap:10px; }
    .bottom-nav { position:fixed; left:0; right:0; bottom:0; background:white; border-top:1px solid #eee; padding:8px 12px; }
    #map-modal .modal-dialog { max-width:420px; margin: 1rem; }
    #map { height: 320px; border-radius:8px; }
    .small-muted { font-size:0.85rem; color:#666; }
    .whatsapp-btn { background:#25D366; color:white; border:none; }
    .logo-svg { width:28px; height:28px; }
    /* mobile-friendly container spacing */
    .page { padding-bottom:88px; }
  </style>
</head>
<body>

  <div class="container-fluid page">
    <!-- Header / Banner -->
    <div class="app-header d-flex align-items-center justify-content-between">
      <div>
        <h4 class="mb-0">SIAP SURUH, SIAP ANTAR</h4>
        <div class="small-muted">Aplikasi layanan jasa suruhan</div>
      </div>
      <div>
        <!-- simple logo -->
        <svg class="logo-svg" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect width="24" height="24" rx="6" fill="white" />
          <path d="M6 12h12" stroke="#2fa84f" stroke-width="2" stroke-linecap="round"/>
          <path d="M6 8h12" stroke="#ff8a2b" stroke-width="2" stroke-linecap="round"/>
        </svg>
      </div>
    </div>

    <!-- Categories -->
    <div class="mt-3 px-2">
      <div class="row row-cols-3 g-2 cat-row">
        <!-- Antar Jemput -->
        <div class="col">
          <button class="w-100 category-btn" data-bs-toggle="modal" data-bs-target="#modalAntar" title="Jasa Antar">
            <div class="category-icon" style="background:linear-gradient(180deg,#e8fff0,#fff)">
              <!-- motor icon -->
              <i class="bi bi-bicycle" style="font-size:20px;color:var(--green)"></i>
            </div>
            <div>Jasa Antar</div>
          </button>
        </div>

        <!-- Kirim paket -->
        <div class="col">
          <button class="w-100 category-btn" data-bs-toggle="modal" data-bs-target="#modalKirim" title="Kirim Paket">
            <div class="category-icon" style="background:linear-gradient(180deg,#fff5ea,#fff)">
              <i class="bi bi-box-seam" style="font-size:20px;color:var(--orange)"></i>
            </div>
            <div>Kirim Paket</div>
          </button>
        </div>

        <!-- Bersihin rumah -->
        <div class="col">
          <button class="w-100 category-btn" data-bs-toggle="modal" data-bs-target="#modalLayanan" data-service="Bersihin Rumah">
            <div class="category-icon" style="background:#fff">
              <i class="bi bi-house-fill" style="font-size:20px;color:#6aa84f"></i>
            </div>
            <div>Bersihin Rumah</div>
          </button>
        </div>

        <!-- Bersihin kebun -->
        <div class="col">
          <button class="w-100 category-btn" data-bs-toggle="modal" data-bs-target="#modalLayanan" data-service="Bersihin Kebun">
            <div class="category-icon" style="background:#fff">
              <i class="bi bi-tree-fill" style="font-size:20px;color:#3b8b3b"></i>
            </div>
            <div>Bersihin Kebun</div>
          </button>
        </div>

        <!-- Tempel Ban -->
        <div class="col">
          <button class="w-100 category-btn" data-bs-toggle="modal" data-bs-target="#modalLayanan" data-service="Tempel Ban">
            <div class="category-icon" style="background:#fff">
              <i class="bi bi-arrow-repeat" style="font-size:20px;color:#777"></i>
            </div>
            <div>Tempel Ban</div>
          </button>
        </div>

        <!-- Tukang Bangunan -->
        <div class="col">
          <button class="w-100 category-btn" data-bs-toggle="modal" data-bs-target="#modalLayanan" data-service="Tukang Bangunan">
            <div class="category-icon" style="background:#fff">
              <i class="bi bi-building" style="font-size:20px;color:#5a6"></i>
            </div>
            <div>Tukang Bangunan</div>
          </button>
        </div>
      </div>

      <div class="mt-3">
        <div class="card shadow-sm">
          <div class="card-body py-2">
            <div class="small-muted">Panduan singkat:</div>
            <ul class="small mb-0">
              <li>Gunakan tombol "Set Lokasi" pada form untuk mengambil posisi dari maps / GPS.</li>
              <li>Bila mengetik alamat tujuan, tekan tombol "Cari" lalu pilih hasil untuk menetapkan lokasi di maps.</li>
              <li>Tarif dihitung otomatis berdasarkan jarak (6000/KM) dan dibulatkan ke ribuan sesuai aturan.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Antar Jemput -->
    <div class="modal fade" id="modalAntar" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Form Antar Jemput</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="formAntar">
              <div class="mb-2">
                <label class="form-label">Nama</label>
                <input required class="form-control" id="antar_nama" placeholder="Nama pemesan">
              </div>

              <div class="mb-2">
                <label class="form-label">Lokasi Jemputan</label>
                <div class="input-group">
                  <input id="jemput_url" class="form-control" placeholder="Belum diset..." readonly>
                  <button class="btn btn-outline-secondary" type="button" id="openMapJemput">Set Lokasi</button>
                </div>
                <div class="small-muted">Bisa ambil dari GPS/geser pin di maps.</div>
              </div>

              <div class="mb-2">
                <label class="form-label">Tujuan Antar</label>
                <div class="input-group mb-1">
                  <input id="antar_text" class="form-control" placeholder="Ketik alamat (opsional) atau gunakan Set Lokasi">
                  <button class="btn btn-outline-secondary" type="button" id="cariTujuan">Cari</button>
                </div>
                <div class="input-group">
                  <input id="tujuan_url" class="form-control" placeholder="Belum diset..." readonly>
                  <button class="btn btn-outline-secondary" type="button" id="openMapTujuan">Set Lokasi</button>
                </div>
                <div class="small-muted">Ketik alamat lalu tekan Cari untuk memilih hasil dan men-set lokasi di maps.</div>
              </div>

              <div class="mb-2">
                <label class="form-label">Metode Bayar</label>
                <select id="antar_metode" class="form-select">
                  <option> CASH </option>
                  <option> TRANSFER </option>
                  <option> QRIS </option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">Estimasi Jarak & Tarif</label>
                <div class="p-2 border rounded">
                  <div>Jarak: <span id="jarakText">-</span></div>
                  <div>Tarif (6.000/KM): <strong id="tarifText">-</strong></div>
                </div>
              </div>

              <div class="d-grid mt-2">
                <button class="btn whatsapp-btn" type="button" id="kirimAntarWA">
                  <i class="bi bi-whatsapp"></i> Kirim Pesanan ke WA Admin
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Kirim Paket -->
    <div class="modal fade" id="modalKirim" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Form Kirim Paket</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="formKirim">
              <div class="mb-2">
                <label class="form-label">Nama</label>
                <input required class="form-control" id="kirim_nama" placeholder="Nama pemesan">
              </div>

              <div class="mb-2">
                <label class="form-label">Lokasi Jemputan</label>
                <div class="input-group">
                  <input id="kirim_jemput_url" class="form-control" placeholder="Belum diset..." readonly>
                  <button class="btn btn-outline-secondary" type="button" id="openMapKirimJemput">Set Lokasi</button>
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label">Tujuan</label>
                <div class="input-group mb-1">
                  <input id="kirim_tujuan_text" class="form-control" placeholder="Ketik alamat (opsional)">
                  <button class="btn btn-outline-secondary" type="button" id="cariKirimTujuan">Cari</button>
                </div>
                <div class="input-group">
                  <input id="kirim_tujuan_url" class="form-control" placeholder="Belum diset..." readonly>
                  <button class="btn btn-outline-secondary" type="button" id="openMapKirimTujuan">Set Lokasi</button>
                </div>
              </div>

              <div class="mb-2">
                <label class="form-label">Metode Bayar</label>
                <select id="kirim_metode" class="form-select">
                  <option> CASH </option>
                  <option> TRANSFER </option>
                  <option> QRIS </option>
                </select>
              </div>

              <div class="mb-2">
                <label class="form-label">Estimasi Jarak & Tarif</label>
                <div class="p-2 border rounded">
                  <div>Jarak: <span id="kirimJarakText">-</span></div>
                  <div>Tarif (6.000/KM): <strong id="kirimTarifText">-</strong></div>
                </div>
              </div>

              <div class="d-grid mt-2">
                <button class="btn whatsapp-btn" type="button" id="kirimKirimWA">
                  <i class="bi bi-whatsapp"></i> Kirim Pesanan ke WA Admin
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Layanan (Bersihin rumah/kebun/tempel ban/tukang) -->
    <div class="modal fade" id="modalLayanan" tabindex="-1">
      <div class="modal-dialog modal-fullscreen-sm-down">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="layananTitle">Form Layanan</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <form id="formLayanan">
              <div class="mb-2">
                <label class="form-label">Nama</label>
                <input required class="form-control" id="layanan_nama" placeholder="Nama pemesan">
              </div>

              <div class="mb-2">
                <label class="form-label">Alamat Lengkap</label>
                <textarea id="layanan_alamat" class="form-control" rows="2" placeholder="Alamat lengkap"></textarea>
              </div>

              <div class="mb-2">
                <label class="form-label">Set Lokasi</label>
                <div class="input-group">
                  <input id="layanan_url" class="form-control" placeholder="Belum diset..." readonly>
                  <button class="btn btn-outline-secondary" type="button" id="openMapLayanan">Set Lokasi</button>
                </div>
                <div class="small-muted">Ambil lokasi lewat GPS / pin di maps.</div>
              </div>

              <div class="mb-2">
                <label class="form-label">Kebutuhan Jasa</label>
                <input id="layanan_kebutuhan" class="form-control" placeholder="Contoh: Bersihkan 1 kamar, memotong rumput...">
              </div>

              <div class="mb-2">
                <label class="form-label">Pertanyaan Estimasi Biaya (opsional)</label>
                <textarea id="layanan_pertanyaan" class="form-control" rows="2"></textarea>
              </div>

              <div class="d-grid mt-2">
                <button class="btn whatsapp-btn" type="button" id="kirimLayananWA">
                  <i class="bi bi-whatsapp"></i> Kirim Pesanan ke WA Admin
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Map Modal (shared) -->
    <div class="modal fade" id="mapModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" id="map-modal">
          <div class="modal-header">
            <h6 class="modal-title" id="mapModalTitle">Set Lokasi</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" id="closeMapModal"></button>
          </div>
          <div class="modal-body">
            <div id="map"></div>
            <div class="mt-2 d-flex gap-2">
              <button id="useMarker" class="btn btn-primary flex-fill">Gunakan Lokasi Pin</button>
              <button id="centerGps" class="btn btn-outline-secondary flex-fill">Paksa GPS</button>
            </div>
            <div class="small-muted mt-2">Geser pin untuk atur titik. Klik peta untuk pindahkan pin.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bottom nav -->
    <div class="bottom-nav d-flex justify-content-around align-items-center">
      <button class="btn btn-link text-center" id="navHome">
        <i class="bi bi-house-door-fill" style="font-size:18px;color:var(--green)"></i><br><small>Home</small>
      </button>
      <button class="btn btn-link text-center" id="navQ">
        <i class="bi bi-question-circle" style="font-size:18px;color:var(--orange)"></i><br><small>Pertanyaan</small>
      </button>
      <button class="btn btn-link text-center" id="navProfile">
        <i class="bi bi-person-circle" style="font-size:18px;color:#666"></i><br><small>Profil</small>
      </button>
    </div>

  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    // --- Globals & helpers ---
    const ADMIN_WA = "6281262433533"; // admin number
    function haversine(lat1, lon1, lat2, lon2){
      const R = 6371; // km
      const toRad = v => v * Math.PI/180;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.sin(dLon/2)**2;
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }
    function roundToNearest1000(n){
      // round with .5 threshold
      return Math.round(n/1000) * 1000;
    }
    function formatRupiah(n){
      if (isNaN(n)) return "-";
      return "Rp " + n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }
    function osmLink(lat, lon){
      return `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lon}#map=18/${lat}/${lon}`;
    }

    // --- Shared Map Modal (Leaflet) ---
    let map, marker;
    let currentMapCallback = null; // function to call with {lat,lng}
    let lastCenter = { lat: -6.200000, lng: 106.816666 }; // default Jakarta
    function initMapOnce(){
      if (map) return;
      map = L.map('map', { zoomControl:true }).setView([lastCenter.lat, lastCenter.lng], 13);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap contributors'
      }).addTo(map);

      marker = L.marker([lastCenter.lat, lastCenter.lng], { draggable:true }).addTo(map);

      // click to move marker
      map.on('click', function(e){
        marker.setLatLng(e.latlng);
      });

      // Try to center to user's GPS
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const p = pos.coords;
          map.setView([p.latitude, p.longitude], 15);
          marker.setLatLng([p.latitude, p.longitude]);
        }, ()=>{ /* ignore */ }, { enableHighAccuracy:true });
      }
    }

    // Open map modal and register callback
    function openMapModal(title, callback){
      currentMapCallback = callback;
      const mm = new bootstrap.Modal(document.getElementById('mapModal'));
      document.getElementById('mapModalTitle').textContent = title;
      mm.show();
      setTimeout(()=> {
        initMapOnce();
        map.invalidateSize();
      }, 250);
    }

    document.getElementById('useMarker').addEventListener('click', ()=>{
      const latlng = marker.getLatLng();
      if (currentMapCallback) currentMapCallback({lat: latlng.lat, lng: latlng.lng});
      // close modal
      bootstrap.Modal.getInstance(document.getElementById('mapModal')).hide();
    });
    document.getElementById('centerGps').addEventListener('click', ()=> {
      if (navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          const p = pos.coords;
          map.setView([p.latitude, p.longitude], 16);
          marker.setLatLng([p.latitude, p.longitude]);
        }, err=>{
          alert("Gagal mendapatkan GPS: " + err.message);
        }, { enableHighAccuracy:true });
      } else alert("Perangkat tidak mendukung geolocation.");
    });

    // --- Modal triggers for set-location buttons ---
    // Antar
    document.getElementById('openMapJemput').addEventListener('click', ()=>{
      openMapModal("Set Lokasi Jemput", ({lat,lng})=>{
        const url = osmLink(lat,lng);
        document.getElementById('jemput_url').value = url;
        updateAntarEstimate();
      });
    });
    document.getElementById('openMapTujuan').addEventListener('click', ()=>{
      openMapModal("Set Lokasi Tujuan", ({lat,lng})=>{
        const url = osmLink(lat,lng);
        document.getElementById('tujuan_url').value = url;
        updateAntarEstimate();
      });
    });

    // Kirim Paket
    document.getElementById('openMapKirimJemput').addEventListener('click', ()=>{
      openMapModal("Set Lokasi Jemput (Kirim Paket)", ({lat,lng})=>{
        document.getElementById('kirim_jemput_url').value = osmLink(lat,lng);
        updateKirimEstimate();
      });
    });
    document.getElementById('openMapKirimTujuan').addEventListener('click', ()=>{
      openMapModal("Set Lokasi Tujuan (Kirim Paket)", ({lat,lng})=>{
        document.getElementById('kirim_tujuan_url').value = osmLink(lat,lng);
        updateKirimEstimate();
      });
    });

    // Layanan umum
    document.getElementById('openMapLayanan').addEventListener('click', ()=>{
      openMapModal("Set Lokasi Layanan", ({lat,lng})=>{
        document.getElementById('layanan_url').value = osmLink(lat,lng);
      });
    });

    // --- Geocoding (Nominatim) for typed address ---
    async function geocodeAndSet(inputId, callback){
      const q = document.getElementById(inputId).value.trim();
      if (!q) return alert("Masukkan alamat yang ingin dicari.");
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=5`;
      try {
        const res = await fetch(url, {headers:{'Accept':'application/json'}});
        const data = await res.json();
        if (!data || data.length === 0) return alert("Tidak ditemukan hasil untuk: " + q);
        // show simple choices
        const list = data.map((d,i)=>`${i+1}. ${d.display_name}`).join("\n");
        const pick = prompt("Pilih nomor hasil: \n" + list + "\nKetik nomor (1 - " + data.length + ")", "1");
        const idx = parseInt(pick) - 1;
        if (isNaN(idx) || idx < 0 || idx >= data.length) return alert("Pilihan tidak valid.");
        const pickObj = data[idx];
        callback({lat: parseFloat(pickObj.lat), lng: parseFloat(pickObj.lon), display_name: pickObj.display_name});
        // center map and marker
        initMapOnce();
        map.setView([pickObj.lat, pickObj.lon], 16);
        marker.setLatLng([pickObj.lat, pickObj.lon]);
      } catch (e){
        alert("Gagal geocoding: " + e.message);
      }
    }

    document.getElementById('cariTujuan').addEventListener('click', ()=> {
      geocodeAndSet('antar_text', ({lat,lng,display_name})=>{
        document.getElementById('tujuan_url').value = osmLink(lat,lng);
        updateAntarEstimate();
      });
    });
    document.getElementById('cariKirimTujuan').addEventListener('click', ()=> {
      geocodeAndSet('kirim_tujuan_text', ({lat,lng,display_name})=>{
        document.getElementById('kirim_tujuan_url').value = osmLink(lat,lng);
        updateKirimEstimate();
      });
    });

    // --- Estimate calculations ---
    function parseLatLonFromOSMUrl(url){
      // expect format like ...?mlat=LAT&mlon=LON...
      try {
        const u = new URL(url);
        const lat = parseFloat(u.searchParams.get('mlat'));
        const lon = parseFloat(u.searchParams.get('mlon'));
        if (isNaN(lat) || isNaN(lon)) return null;
        return {lat, lon};
      } catch(e){ return null; }
    }

    function updateAntarEstimate(){
      const jurl = document.getElementById('jemput_url').value;
      const turl = document.getElementById('tujuan_url').value;
      const j = parseLatLonFromOSMUrl(jurl);
      const t = parseLatLonFromOSMUrl(turl);
      if (!j || !t){ document.getElementById('jarakText').textContent = '-'; document.getElementById('tarifText').textContent = '-'; return; }
      const km = haversine(j.lat, j.lon, t.lat, t.lon);
      const tarifRaw = Math.round(km * 6000);
      const tarif = roundToNearest1000(tarifRaw);
      document.getElementById('jarakText').textContent = km.toFixed(2) + ' km';
      document.getElementById('tarifText').textContent = formatRupiah(tarif);
    }

    function updateKirimEstimate(){
      const jurl = document.getElementById('kirim_jemput_url').value;
      const turl = document.getElementById('kirim_tujuan_url').value;
      const j = parseLatLonFromOSMUrl(jurl);
      const t = parseLatLonFromOSMUrl(turl);
      if (!j || !t){ document.getElementById('kirimJarakText').textContent = '-'; document.getElementById('kirimTarifText').textContent = '-'; return; }
      const km = haversine(j.lat, j.lon, t.lat, t.lon);
      const tarifRaw = Math.round(km * 6000);
      const tarif = roundToNearest1000(tarifRaw);
      document.getElementById('kirimJarakText').textContent = km.toFixed(2) + ' km';
      document.getElementById('kirimTarifText').textContent = formatRupiah(tarif);
    }

    // --- WA Message creators ---
    function createWaLink(text){
      const base = "https://wa.me/" + ADMIN_WA + "?text=" + encodeURIComponent(text);
      return base;
    }

    document.getElementById('kirimAntarWA').addEventListener('click', ()=>{
      const n = document.getElementById('antar_nama').value || '-';
      const jemput = document.getElementById('jemput_url').value || '-';
      const tujuan = document.getElementById('tujuan_url').value || '-';
      const metode = document.getElementById('antar_metode').value || '-';
      const jarak = document.getElementById('jarakText').textContent || '-';
      const tarif = document.getElementById('tarifText').textContent || '-';

      const msg = `*PESANAN ANTAR JEMPUT*\nNama: ${n}\nLokasi Jemput: ${jemput}\nTujuan Antar: ${tujuan}\nMetode Bayar: ${metode}\nEstimasi Jarak: ${jarak}\nEstimasi Tarif: ${tarif}\n\nMohon konfirmasi.`;
      const link = createWaLink(msg);
      window.open(link, '_blank');
    });

    document.getElementById('kirimKirimWA').addEventListener('click', ()=>{
      const n = document.getElementById('kirim_nama').value || '-';
      const jemput = document.getElementById('kirim_jemput_url').value || '-';
      const tujuan = document.getElementById('kirim_tujuan_url').value || '-';
      const metode = document.getElementById('kirim_metode').value || '-';
      const jarak = document.getElementById('kirimJarakText').textContent || '-';
      const tarif = document.getElementById('kirimTarifText').textContent || '-';

      const msg = `*PESANAN KIRIM PAKET*\nNama: ${n}\nLokasi Jemput: ${jemput}\nTujuan: ${tujuan}\nMetode Bayar: ${metode}\nEstimasi Jarak: ${jarak}\nEstimasi Tarif: ${tarif}\n\nMohon konfirmasi.`;
      const link = createWaLink(msg);
      window.open(link, '_blank');
    });

    document.getElementById('kirimLayananWA').addEventListener('click', ()=>{
      const jenis = document.getElementById('layananTitle').textContent || 'Layanan';
      const n = document.getElementById('layanan_nama').value || '-';
      const alamat = document.getElementById('layanan_alamat').value || '-';
      const url = document.getElementById('layanan_url').value || '-';
      const kebutuhan = document.getElementById('layanan_kebutuhan').value || '-';
      const pertanyaan = document.getElementById('layanan_pertanyaan').value || '-';

      const msg = `*PESANAN ${jenis.toUpperCase()}*\nNama: ${n}\nAlamat Lengkap: ${alamat}\nLokasi: ${url}\nKebutuhan Jasa: ${kebutuhan}\nPertanyaan Estimasi Biaya: ${pertanyaan}\n\nMohon konfirmasi.`;
      const link = createWaLink(msg);
      window.open(link, '_blank');
    });

    // --- Modal Layanan title setter (for different service buttons) ---
    const layananModalEl = document.getElementById('modalLayanan');
    layananModalEl.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const service = button.getAttribute('data-service') || 'Layanan';
      document.getElementById('layananTitle').textContent = service;
    });

    // --- Extra: auto-update estimates when URLs change manually ---
    const observerIds = ['jemput_url','tujuan_url','kirim_jemput_url','kirim_tujuan_url'];
    observerIds.forEach(id=>{
      document.getElementById(id).addEventListener('change', ()=>{
        updateAntarEstimate(); updateKirimEstimate();
      });
    });

    // --- Initialize small behaviors ---
    document.addEventListener('DOMContentLoaded', ()=> {
      // nav buttons
      document.getElementById('navHome').addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
      document.getElementById('navQ').addEventListener('click', ()=> alert('Untuk pertanyaan, silakan chat admin via WhatsApp.')); 
      document.getElementById('navProfile').addEventListener('click', ()=> alert('Profil belum diimplementasikan (demo).'));

      // when map modal closes, keep last center
      document.getElementById('mapModal').addEventListener('hidden.bs.modal', ()=> {
        const c = map ? map.getCenter() : null;
        if (c) { lastCenter = {lat:c.lat, lng:c.lng}; }
      });
    });
  </script>
</body>
</html>
